# LinkSauce APIå¼€æ”¾å¹³å°å¼€å‘æ–‡æ¡£

## ä¸€ã€é¡¹ç›®è„šæ‰‹æ¶æ­å»º

### 1ã€Ant Design Pro

> æŸ¥çœ‹ [å®˜æ–¹æ–‡æ¡£](pro.ant.design/zh-CN/docs/getting-started)

1. å®‰è£…åˆå§‹åŒ–è„šæ‰‹æ¶

   ```shell
   # ä½¿ç”¨ npm
   npm i @ant-design/pro-cli -g
   ```

2. æ‰“å¼€å°†è¦å­˜æ”¾é¡¹ç›®çš„æ–‡ä»¶å¤¹ åˆ›å»ºé¡¹ç›®

   ```shell
   pro create linksauce-frontend
   ```

   **é€‰æ‹©umiç‰ˆæœ¬**

   >   ```shell
   >   ? ğŸ‚ ä½¿ç”¨ umi@4 è¿˜æ˜¯ umi@3 ? (Use arrow keys)
   >   â¯ umi@4
   >    umi@3
   >   ```

3. å®‰è£…yarn

   ```shell
   # å…¨å±€å®‰è£…
   npm install -g yarn
   ```

   æŸ¥çœ‹yarnç‰ˆæœ¬

   ```shell
   yarn -version
   ```

4. å®‰è£…ä¾èµ–

   ```shell
   yarn
   ```

5. è¿è¡Œæµ‹è¯•`package.json`ä¸­çš„`start`

   ![image-20240329154642753](å¼€å‘æ–‡æ¡£.assets/image-20240329154642753.png)

   ![image-20240329154745288](å¼€å‘æ–‡æ¡£.assets/image-20240329154745288.png)

6. é¡¹ç›®ç˜¦èº«ï¼Œ**æœ‰å‘ï¼Œå¯è·³è¿‡ï¼ï¼ï¼**

   - è¿è¡Œ`package.json`ä¸­çš„`i18n-remove`å»é™¤å›½é™…åŒ–ï¼Œæ‰‹åŠ¨åˆ é™¤`src\locales`

     > å¦‚æœæŠ¥é”™ï¼Œæ£€æŸ¥ä¸€ä¸‹æ˜¯ä¸æ˜¯æ²¡åˆ å¹²å‡€ï¼Œå¯ä»¥æ‰‹åŠ¨å»é™¤

     **AntDesignå»å›½é™…åŒ– å routeré¡µé¢æ˜¾ç¤ºé—®é¢˜ï¼š**

     >   è§£å†³æ–¹æ³•ï¼šæ‰§è¡Œ 
     >
     >   yarn add eslint-config-prettier
     >
     >   yarn add eslint-plugin-unicorn
     >
     >   ç„¶åä¿®æ”¹node_modules/@umijs/lint/dist/config/eslint/index.js 
     >
     >   // es2022: trueæŠŠè¿™ä¸ªæ³¨é‡Šæ‰å°±å¯ä»¥è§£å†³é—®é¢˜

     å¦‚æœä¸è¡Œï¼Œä¿®æ”¹`config\routes.ts`å¦‚ä¸‹å³å¯ï¼š

     ```ts
     export default [
       { name: 'ç™»å½•', path: '/user', layout: false, routes: [{ path: '/user/login', component: './User/Login' }] },
       { name: 'æ¬¢è¿é¡µé¢', path: '/welcome', icon: 'smile', component: './Welcome' },
       {
         path: '/admin',
         icon: 'crown',
         access: 'canAdmin',
         name: 'ç®¡ç†å‘˜é¡µé¢',
         routes: [
           { path: '/admin', redirect: '/admin/sub-page' },
           { path: '/admin/sub-page', component: './Admin' },
         ],
       },
       { icon: 'table', path: '/list', component: './TableList', name: 'è¡¨æ ¼é¡µ' },
       { path: '/', redirect: '/welcome' },
       { path: '*', layout: false, component: './404' },
     ];
     ```

   - åˆ é™¤`src\tests`

7. é‡æ–°å®‰è£…ä¾èµ–ï¼Œé‡å¤ç¬¬äº”æ­¥ï¼Œç¡®è®¤æ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œ

   ```shell
   yarn
   ```



### 2ã€åç«¯

#### 2.1. åˆå§‹åŒ–

> å‚è€ƒä½¿ç”¨[springboot-initæ¨¡æ¿](https://github.com/zhOhh/sptingboot-init)

#### 2.2. æ•°æ®åº“è¡¨è®¾è®¡

**åŸºæœ¬ç»“æ„**

| å­—æ®µå         | å¤‡æ³¨                         |
| -------------- | ---------------------------- |
| id             | ç”¨æˆ·id                       |
| name           | åç§°                         |
| description    | æè¿°                         |
| url            | æ¥å£åœ°å€                     |
| request_header | è¯·æ±‚å¤´                       |
| reponse_header | å“åº”å¤´                       |
| status         | æ¥å£çŠ¶æ€ï¼ˆ0-å…³é—­ 1-å¼€å¯ï¼‰    |
| method         | è¯·æ±‚ç±»å‹                     |
| user_id        | åˆ›å»ºäºº                       |
| create_time    | åˆ›å»ºæ—¶é—´                     |
| update_time    | æ›´æ–°æ—¶é—´                     |
| is_delete      | é€»è¾‘åˆ é™¤ ï¼ˆ0-æœªåˆ  ï¼Œ1-å·²åˆ ï¼‰ |

**ä»£ç **

> å¯ä»¥ç”¨é±¼çš®å†™çš„sqlç”Ÿæˆå·¥å…·ç”Ÿæˆä¸€ä¸‹ä»£ç    [SQLä¹‹çˆ¶](https://www.sqlfather.com/)

å¡«å¯¹åº”çš„æ•°æ®ï¼Œä¸€é”®ç”Ÿæˆå³å¯

```sql
use linksauce;

-- æ¥å£ä¿¡æ¯
create table if not exists linksauce.`interface_info`
(
    `id` bigint not null auto_increment comment 'ä¸»é”®' primary key,
    `name` varchar(256) not null comment 'åç§°',
    `description` varchar(256) null comment 'æè¿°',
    `url` varchar(512) not null comment 'æ¥å£åœ°å€',
    `requestHeader` text null comment 'è¯·æ±‚å¤´',
    `responseHeader` text null comment 'å“åº”å¤´',
    `status` int default 0 not null comment 'æ¥å£çŠ¶æ€ï¼ˆ0-å…³é—­ï¼Œ1-å¼€å¯ï¼‰',
    `method` varchar(256) not null comment 'è¯·æ±‚ç±»å‹',
    `userId` bigint not null comment 'åˆ›å»ºäºº',
    `createTime` datetime default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    `updateTime` datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    `isDelete` tinyint default 0 not null comment 'æ˜¯å¦åˆ é™¤(0-æœªåˆ , 1-å·²åˆ )'
) comment 'æ¥å£ä¿¡æ¯';

insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('å»–ç«‹è½©', 'è„±é¢–è€Œå‡º', 'www.foster-larkin.co', 'é¾™å˜‰æ‡¿', 'ç§¦å¤©ç£Š', 0, 'GET', 1718083101);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('æ›¹æ˜è¾‰', 'ä¸¾ä¸€åä¸‰', 'www.tony-kiehn.com', 'ä»»æ“è‹', 'é™ˆå‡¯ç‘', 0, 'GET', 28978);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('é‡‘ä¹é©¹', 'é¦–å½“å…¶å†²', 'www.coleen-prosacco.net', 'æ¯›æµ©', 'é™†è‡´è¿œ', 0, 'GET', 208);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('å»–æ€', 'æ¥ä¹‹ä¸æ˜“', 'www.don-sipes.net', 'æ¢å½¬', 'ç™½å›æµ©', 0, 'GET', 470);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('è‘£ç…œç¥º', 'é•¿æ²»ä¹…å®‰', 'www.terry-turner.co', 'è¦ƒç»é½', 'èƒ¡é›ªæ¾', 0, 'GET', 611007);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('ä¾¯èªå¥', 'ç²¾å¿ƒè®¾è®¡', 'www.augustus-yost.info', 'å‚…é¸¿ç…Š', 'æ½˜é¹é£', 0, 'GET', 0);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('é­å¼˜æ–‡', 'ç©å¿½èŒå®ˆ', 'www.guadalupe-beatty.biz', 'æ±Ÿæ¢“æ™¨', 'é­æ€æ·¼', 0, 'GET', 1162536022);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('äºè‹‘åš', 'å„å¼å„æ ·', 'www.nolan-metz.net', 'éŸ¦æœ', 'é‡‘èƒ¤ç¥¥', 0, 'GET', 0);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('å§šç‚«æ˜', 'ç¿»å¤©è¦†åœ°', 'www.jodie-schultz.info', 'è®¸è¶Šå½¬', 'æ¯›æ™‹é¹', 0, 'GET', 973);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('å­™é‘«é¹', 'ç»œç»ä¸ç»', 'www.liza-sporer.co', 'å­™å½¬', 'å‚…é¸¿ç…Š', 0, 'GET', 30308);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('å”å±•é¹', 'é“¤è€Œèµ°é™©', 'www.hayden-purdy.co', 'æ¨å“²ç€š', 'é™†å‡¯ç‘', 0, 'GET', 473462835);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('æ›¹æ“è‹', 'èµä¸ç»å£', 'www.phung-glover.org', 'é‚±å¿—æ³½', 'å¼ å¥é›„', 0, 'GET', 32155653);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('å¤çƒ¨éœ–', 'å“­ç¬‘ä¸å¾—', 'www.augustine-funk.org', 'å®‹èªå¥', 'éƒé¹æ¶›', 0, 'GET', 3964);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('è‘£æµ©', 'å¯¹ç—‡ä¸‹è¯', 'www.erik-hamill.biz', 'é»ç«‹æœ', 'å»–é¹¤è½©', 0, 'GET', 2275);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('ç½—è£è½©', 'å–œé—»ä¹è§', 'www.gia-hermann.biz', 'éŸ©ç…œåŸ', 'é˜è€€æ°', 0, 'GET', 847);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('æ²ˆæ­£è±ª', 'ç»Ÿç­¹å…¼é¡¾', 'www.isabella-reinger.io', 'é‚“å­è½©', 'å»–ä¼Ÿè¯š', 0, 'GET', 997378602);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('ä»»ç«‹æœ', 'å‡ºäººæ„æ–™', 'www.geoffrey-koss.name', 'è¦ƒæµ©ç„¶', 'è§é›¨æ³½', 0, 'GET', 403);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('å¼ ç‚«æ˜', 'åä¸è™šä¼ ', 'www.ellan-gleason.com', 'é»æ­£è±ª', 'éŸ¦ç‚å½¬', 0, 'GET', 35127293);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('æ–¹é›¨æ³½', 'è¡£é£Ÿä½è¡Œ', 'www.wilton-walsh.biz', 'é»è¶Šæ³½', 'ç™½è¿œèˆª', 0, 'GET', 62264);
insert into linksauce.`interface_info` (`name`, `description`, `url`, `requestHeader`, `responseHeader`, `status`, `method`, `userId`) values ('è¢å¤©ç¿Š', 'å·åœŸé‡æ¥', 'www.lynetta-mclaughlin.info', 'é‚¹ç† å½¤', 'å¶æ½‡ç„¶', 0, 'GET', 9884455);
```

#### 2.3. MabatisXæ’ä»¶

ç”Ÿæˆdomainã€mapperã€service

æ‰“å¼€æ–°å»ºçš„è¡¨ï¼Œå³å‡»é€‰æ‹©MybatisX-Generator

å‹¾ä¸Šé©¼å³°

![image-20240329175949857](å¼€å‘æ–‡æ¡£.assets/image-20240329175949857.png)

æ ¹æ®**ç‰ˆæœ¬å’Œéœ€è¦æ‰“å‹¾**ï¼Œç‚¹å‡»å®Œæˆ

![image-20240329180554301](å¼€å‘æ–‡æ¡£.assets/image-20240329180554301.png)

#### 2.4. Controller

> æˆ‘ä»¬åªéœ€è¦å°†**PostController**å¤åˆ¶ä¸€ä»½æ”¹åä¸º**InterfaceInfoController**å³å¯,å› ä¸ºé€»è¾‘æ˜¯å·®ä¸å¤šï¼Œéƒ½æ˜¯è¿›è¡Œå¢åˆ æ”¹æŸ¥

ç„¶åå°†postæ”¹æˆinterfaceInfoã€Postæ”¹æˆInterfaceInfo

æ ¹æ®æŠ¥é”™ä¿¡æ¯æˆ‘ä»¬æ¥è¡¥å……ä¿¡æ¯



#### 2.5. Model

##### (1) Entity

```java
package com.ohh.project.model.entity;

import com.baomidou.mybatisplus.annotation.*;

import java.io.Serializable;
import java.util.Date;
import lombok.Data;

/**
 * æ¥å£ä¿¡æ¯
 * @TableName interface_info
 */
@TableName(value ="interface_info")
@Data
public class InterfaceInfo implements Serializable {
    /**
     * ä¸»é”®
     */
    @TableId(type = IdType.AUTO)
    private Long id;

    /**
     * åç§°
     */
    private String name;

    /**
     * æè¿°
     */
    private String description;

    /**
     * æ¥å£åœ°å€
     */
    private String url;

    /**
     * è¯·æ±‚å¤´
     */
    private String requestHeader;

    /**
     * å“åº”å¤´
     */
    private String responseHeader;

    /**
     * æ¥å£çŠ¶æ€ï¼ˆ0-å…³é—­ï¼Œ1-å¼€å¯ï¼‰
     */
    private Integer status;

    /**
     * è¯·æ±‚ç±»å‹
     */
    private String method;

    /**
     * åˆ›å»ºäºº
     */
    private Long userId;

    /**
     * åˆ›å»ºæ—¶é—´
     */
    private Date createTime;

    /**
     * æ›´æ–°æ—¶é—´
     */
    private Date updateTime;

    /**
     * æ˜¯å¦åˆ é™¤(0-æœªåˆ , 1-å·²åˆ )
     */
    @TableLogic
    private Integer isDelete;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```

##### (2) DTO

é¦–å…ˆå…ˆå¢åŠ DTOï¼Œåœ¨InterfaceInfoç±»ä»æ‹¿æˆ‘ä»¬éœ€è¦çš„ä¿¡æ¯åšæˆä¸‰ä¸ªDTOç±»ï¼ˆåˆ†åˆ«æ˜¯æ–°å¢ã€æŸ¥è¯¢ã€æ›´æ–°ï¼‰åˆ é™¤çš„è¯·æ±‚æˆ‘ä»¬å°è£…åœ¨commonåŒ…ä¸‹

![image-20230112184904561](å¼€å‘æ–‡æ¡£.assets/image-20230112184904561.png)



#### 2.6. Service

æ ¹æ®æŠ¥é”™å¯çŸ¥ serviceå±‚ç¼ºå°‘ä¸€ä¸ªæ–¹æ³•validInterfaceInfo

```java
package com.ohh.project.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.ohh.project.common.ErrorCode;
import com.ohh.project.exception.BusinessException;
import com.ohh.project.mapper.InterfaceInfoMapper;
import com.ohh.project.model.entity.InterfaceInfo;
import com.ohh.project.service.InterfaceInfoService;
import org.apache.commons.lang3.ObjectUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.stereotype.Service;

/**
* @author 12994
* @description é’ˆå¯¹è¡¨ã€interface_info(æ¥å£ä¿¡æ¯)ã€‘çš„æ•°æ®åº“æ“ä½œServiceå®ç°
* @createDate 2024-03-29 18:05:35
*/
@Service
public class InterfaceInfoServiceImpl extends ServiceImpl<InterfaceInfoMapper, InterfaceInfo>
    implements InterfaceInfoService {

    @Override
    public void validInterfaceInfo(InterfaceInfo interfaceInfo, boolean add) {
        if (interfaceInfo == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }

        String name = interfaceInfo.getName();
        String description = interfaceInfo.getDescription();
        String url = interfaceInfo.getUrl();
        String requestHeader = interfaceInfo.getRequestHeader();
        String responseHeader = interfaceInfo.getResponseHeader();
        Integer status = interfaceInfo.getStatus();
        String method = interfaceInfo.getMethod();
        Long userId = interfaceInfo.getUserId();

        // åˆ›å»ºæ—¶ï¼Œæ‰€æœ‰å‚æ•°å¿…é¡»éç©º
        if (add) {
            if (StringUtils.isAnyBlank(name, description, url, requestHeader, responseHeader, method) || ObjectUtils.anyNull(userId, status)) {
                throw new BusinessException(ErrorCode.PARAMS_ERROR);
            }
        }
        if (StringUtils.isNotBlank(name) && name.length() > 256) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "åå­—è¿‡é•¿");
        }
        if (StringUtils.isNotBlank(description) && description.length() > 512) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "æè¿°è¿‡é•¿");
        }
    }

}

```

### 3ã€å‰ç«¯

#### 3.1. é…ç½®æ’ä»¶

ä¸ºäº†é¡¹ç›®æ›´åŠ è§„èŒƒ

> æœç´¢ **eslint** é€‰ä¸Šè‡ªåŠ¨è¯†åˆ«

![image-20230112193957977](å¼€å‘æ–‡æ¡£.assets/image-20230112193957977.png)



> æœç´¢**prettier** æ‰“âˆš  ç¾åŒ–ä»£ç 

![image-20230112194107217](å¼€å‘æ–‡æ¡£.assets/image-20230112194107217.png)

#### 3.2. æ¥å£è°ƒç”¨

ä½¿ç”¨ **oneapi** æ’ä»¶è‡ªåŠ¨ç”Ÿæˆ

å¦‚æœè¦å‰ç«¯è‡ªåŠ¨ç”Ÿæˆï¼Œéœ€è¦å°†åç«¯çš„éµå¾ª**openapi**è§„èŒƒçš„**json**æ–‡æ¡£ 

> åç«¯çš„éµå¾ª**openapi**è§„èŒƒçš„**json**æ–‡æ¡£ 

æ‰¾åˆ°æˆ‘ä»¬èµ·çš„åç«¯ä¸»é¡µ

æ‰¾åˆ°æˆ‘ä»¬èµ·çš„åç«¯ä¸»é¡µ

![image-20230112195321863](å¼€å‘æ–‡æ¡£.assets/image-20230112195321863-17118630680604.png)

åœ¨åœ°å€æ è¾“å…¥http://localhost:7529/api/v3/api-docs

å‘ç°å¦‚ä¸‹æ‰€ç¤º

![image-20240331133328390](å¼€å‘æ–‡æ¡£.assets/image-20240331133328390.png)

é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¿™ä¸ªurläº†

**ä¿®æ”¹ï¼š**`config\config.ts` ï¼Œæ‰¾åˆ°**openApi** ä¿®æ”¹å¦‚ä¸‹

```tsx
openAPI: [
    {
      requestLibPath: "import { request } from '@umijs/max'",
      schemaPath: 'http://localhost:7529/api/v3/api-docs',
      projectName: 'linksauce-backend',
    },
  ],
```

æµ‹è¯•ä¸€ä¸‹æ˜¯å¦èƒ½ç”¨

> æ‰¾åˆ°**package.json**,æ‰§è¡Œ**openapi**å‘½ä»¤
>
> ![image-20240331133404196](å¼€å‘æ–‡æ¡£.assets/image-20240331133404196.png)

æ‰§è¡ŒæˆåŠŸï¼ŒæŸ¥çœ‹**service**æ–‡ä»¶å¤¹

![image-20240331133533073](å¼€å‘æ–‡æ¡£.assets/image-20240331133533073.png)

ç”±äºæˆ‘ä»¬æœ‰åç«¯ ï¼Œåº”è¯·æ±‚çœŸå®ç¯å¢ƒï¼Œæ‰€ä»¥ç›´æ¥ç”¨**devæ¨¡å¼**è¿è¡Œ

```bash
npm run start:dev
```

å¯ä»¥å°†é¡¹ç›®ä¸­çš„`requestErrorConfig.ts`æ”¹ä¸º`requestConfig.ts`

ç„¶ååœ¨`app.tsx` æ‰¾åˆ° requesté…ç½®ï¼Œå°†å…¶ä¿®æ”¹æˆæˆ‘ä»¬æ”¹çš„

```java
export const request = {
  ...requestConfig,
};
```

**æ‰¾åˆ°`requestConfig.ts`**

ä¿®æ”¹åå­—ï¼Œå¹¶è®¾ç½®ä¸€ä¸‹åç«¯åœ°å€

**è®¾ç½®cookie!!!**

![image-20240331133754108](å¼€å‘æ–‡æ¡£.assets/image-20240331133754108.png)

> ```java
> baseURL: 'http://localhost:7529',
> withCredentials: true,
> ```

#### 3.3. ä¿®æ”¹ç™»å½•æ¥å£

æ‰¾åˆ°`src/pages/User/Login/index.tsx`ä¸‹çš„**handleSubmit**

ä¿®æ”¹ç”¨æˆ·åå’Œå¯†ç çš„å­—æ®µå’Œåç«¯ä¿æŒä¸€è‡´

**è®¾ç½®ç”¨æˆ·ç™»å½•æ€**

å›åˆ°`app.tsx`æ‰¾åˆ°**getInitialState()**è¿™ä¸ªæ–¹æ³•

è¿™ä¸ªæ–¹æ³•å½“é¦–æ¬¡è®¿é—®é¡µé¢çš„æ—¶å€™ï¼Œè·å–ç”¨æˆ·çš„ä¿¡æ¯ï¼Œè·å–å½“å‰å…¨å±€çš„ä¸€äº›çŠ¶æ€ï¼Œå¯ä»¥æŠŠå®ƒå½“æˆå…¨å±€å˜é‡

æ‰¾åˆ°`typings.d.ts`

```ts
/**
 * å…¨å±€çŠ¶æ€ç±»å‹
 */
interface InitialState{
  loginUser?:API.UserVO;
}
```

è¿”å›**getInitialState()**å°†å®ƒæ”¹ä¸º

```tsx
export async function getInitialState(): Promise<InitialState> {
  // å½“é¡µé¢é¦–æ¬¡åŠ è½½æ—¶ï¼Œè·å–è¦å…¨å±€ä¿å­˜çš„æ•°æ®ï¼Œå¦‚ç”¨æˆ·ç™»å½•ä¿¡æ¯
  const state: InitialState = {
    loginUser: undefined,
  };
  try {
    const res = await getLoginUserUsingGet();
    if (res.data) {
      state.loginUser = res.data;
    }
  } catch (error) {
    history.push(loginPath);
  }
  return state;
}
```



è¿”å›`src/pages/User/Login/index.tsx`ä¸‹çš„**handleSubmit**

è®¾ç½®ç™»å½•çŠ¶æ€

```tsx
  const handleSubmit = async (values: API.UserLoginRequest) => {
    try {
      // ç™»å½•
      const res = await userLoginUsingPOST({ ...values });
      if (res.data) {
        const urlParams = new URL(window.location.href).searchParams;
        history.push(urlParams.get('redirect') || '/');
        setInitialState({
          loginUser: res.data
        });
        return;
      }
    } catch (error) {
      const defaultLoginFailureMessage = intl.formatMessage({
        id: 'pages.login.failure',
        defaultMessage: 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•ï¼',
      });
      console.log(error);
      message.error(defaultLoginFailureMessage);
    }
  };
```

#### 3.4. æ³¨é”€

æ‰¾åˆ°`src/components/RightContent/AvatarDropdown.tsx`çš„**loginout()**å°†å…¶æ”¹ä¸ºè‡ªå·±çš„åç«¯æ–¹æ³•

```java
const onMenuClick = useCallback(
  (event: MenuInfo) => {
    const { key } = event;
    if (key === 'logout') {
      flushSync(() => {
        setInitialState((s) => ({ ...s, currentUser: undefined }));
      });
      userLogoutUsingPost();
      return;
    }
    history.push(`/account/${key}`);
  },
  [setInitialState],
);
```

#### 3.5. è®¾ç½®ç®¡ç†æƒé™ 

ä¿®æ”¹`access.ts`

```ts
/**
 * @see https://umijs.org/docs/max/access#access
 * */
export default function access(initialState: InitialState | undefined) {
  const { loginUser } = initialState ?? {};
  return {
    // canAdmin: currentUser && currentUser.access === 'admin',
    canUser: loginUser,
    canAdmin: loginUser?.userRole === 'admin',
  };
}
 
```

#### 3.6. ä¿®æ”¹è¡¨æ ¼å†…å®¹

æ‰¾åˆ°`src/pages/TableList/index.tsx`çš„**columns**ï¼Œä¿®æ”¹å¦‚ä¸‹

```tsx
const columns: ProColumns<API.InterfaceInfo>[] = [
  {
    title: 'id',
    dataIndex: 'id',
    valueType: 'index',
  },
  {
    title: 'æ¥å£åç§°',
    dataIndex: 'name',
    valueType: 'text',
  },
  {
    title: 'æè¿°',
    dataIndex: 'description',
    valueType: 'textarea',
  },
  {
    title: 'è¯·æ±‚æ–¹æ³•',
    dataIndex: 'method',
    valueType: 'textarea',
  },
  {
    title: 'url',
    dataIndex: 'url',
    valueType: 'text',
  },
  {
    title: 'è¯·æ±‚å¤´',
    dataIndex: 'requestHeader',
    valueType: 'textarea',
  },
  {
    title: 'å“åº”å¤´',
    dataIndex: 'responseHeader',
    valueType: 'textarea',
  },
  {
    title: 'çŠ¶æ€',
    dataIndex: 'status',
    hideInForm: true,
    valueEnum: {
      0: {
        text: 'å…³é—­',
        status: 'Default',
      },
      1: {
        text: 'è¿è¡Œä¸­',
        status: 'Processing',
      },
    },
  },
  {
    title: 'åˆ›å»ºæ—¶é—´',
    dataIndex: 'createTime',
    valueType: 'dateTime',
  },
  {
    title: 'æ›´æ–°æ—¶é—´',
    dataIndex: 'updateTime',
    valueType: 'dateTime',
  },
  {
    title: 'æ“ä½œ',
    dataIndex: 'option',
    valueType: 'option',
    render: (_, record) => [
      <a
        key="config"
        onClick={() => {
          handleUpdateModalOpen(true);
          setCurrentRow(record);
        }}
      >
        é…ç½®
      </a>,
      <a key="subscribeAlert" href="https://procomponents.ant.design/">
        è®¢é˜…è­¦æŠ¥
      </a>,
    ],
  },
];
```

ä¿®æ”¹`request`å¦‚ä¸‹ï¼š

```tsx
request={async (
  params: {
    pageSize?: number;
    current?: number;
    keyword?: string;
  }, sort: Record<string, SortOrder>,  filter: Record<string, React.ReactText[] | null>,) => {
  const res = await listInterfaceInfoByPageUsingGet({ ...params });
  if (res.data) {
    return {
      data: res.data.records || [],
      success: true,
      total: res.data.total,
    };
  } else {
    return {
      data: [],
      success: false,
      total: 0,
    };
  }
}}
```

**åˆ·æ–°é¡µé¢ï¼Œæ˜¾ç¤ºæˆåŠŸ**

![image-20240331135817432](å¼€å‘æ–‡æ¡£.assets/image-20240331135817432.png)



## äºŒã€åŸºç¡€å¢åˆ æ”¹æŸ¥

### 1ã€ä¿®æ”¹è·¯ç”±

æ‰“å¼€**config**åŒ…æ‰¾åˆ° **routes.ts**

å°†åŸæ¥pagesä¸‹çš„**TableList**è¡¨å•åç§°æ”¹ä¸ºæˆ‘ä»¬çš„**interfaceInfo**ï¼Œå†æŠŠæ¥å£ç®¡ç†é¡µé¢é…ç½®åˆ°ç®¡ç†å‘˜é¡µé¢ä¸‹

```js
{
  name: 'æ¥å£ç®¡ç†',
  icon: 'table',
  path: '/admin/interface_info',
  component: './InterfaceInfo',
}
```



```typescript
export default [
  {
    path: '/user',
    layout: false,
    routes: [
      {
        name: 'login',
        path: '/user/login',
        component: './User/Login',
      },
    ],
  },
  {
    path: '/welcome',
    name: 'welcome',
    icon: 'smile',
    component: './Welcome',
  },
  {
    path: '/admin',
    name: 'admin',
    icon: 'crown',
    access: 'canAdmin',
    routes: [
      {
        path: '/admin',
        redirect: '/admin/sub-page',
      },
      {
        path: '/admin/sub-page',
        name: 'sub-page',
        component: './Admin',
      },
      {
        name: 'æ¥å£ç®¡ç†',
        icon: 'table',
        path: '/admin/interface_info',
        component: './InterfaceInfo',
      },
    ],
  },
  {
    path: '/',
    redirect: '/welcome',
  },
  {
    path: '*',
    layout: false,
    component: './404',
  },
];

```

æ•ˆæœå¦‚ä¸‹



### 2ã€æ–°å¢æ¥å£ä¿¡æ¯

---

#### 2.1. è¡¨å•æ¨¡å—

**interfaceInfo**ä¸­çš„**index.tsx**æ‰¾åˆ°æ–°å»ºçš„Button

![image-20230113153334776](å¼€å‘æ–‡æ¡£.assets/image-20230113153334776.png)

æˆ‘ä»¬ç‚¹å‡»æ–°å»ºçš„æ—¶å€™ï¼Œä»–ä¼šæ‰“å¼€ä¸€ä¸ªæ¨¡æ€æ¡†ã€‚å¾€ä¸‹æ‰¾ï¼Œå‘ç°å®ƒå·²ç»ç»™æˆ‘ä»¬æä¾›äº†è¿™ä¸ªç»„ä»¶ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦é‡æ–°å†™

![image-20230113153512970](å¼€å‘æ–‡æ¡£.assets/image-20230113153512970.png)

æˆ‘ä»¬å¯ä»¥å°±åƒæ›´æ–°æ¨¡æ€æ¡†ä¸€æ ·æ–°å»ºä¸€ä¸ªCreateModal.tsx

![image-20230113153639726](å¼€å‘æ–‡æ¡£.assets/image-20230113153639726.png)

æ¥ä¸‹æ¥ä¿®æ”¹ä»UpdateFormä¸­ç²˜è´´çš„**CreateModal.tsx**çš„ä»£ç 

```tsx
import { Modal } from 'antd';
import React from 'react';
import { ProColumns, ProTable } from '@ant-design/pro-components';
import '@umijs/max';

export type Props = {
  columns: ProColumns<API.InterfaceInfo>[];
  onCancel: () => void;
  onSubmit: (values: API.InterfaceInfo) => Promise<boolean>;
  open: boolean;
};

const CreateModal: React.FC<Props> = (props) => {
  const { columns, open, onCancel } = props;
  return (
    <Modal open={open} onCancel={() => onCancel?.()}>
      <ProTable columns={columns} />
    </Modal>
  );
};

export default CreateModal;
```

**è¿™é‡Œæˆ‘ä»¬å¤ç”¨äº†indexä¸­çš„columns**  è¿™é‡Œæˆ‘é¡ºä¾¿æŠŠå–æ¶ˆä¹Ÿå†™äº†

åœ¨**index.tsx**ä¸­ä½¿ç”¨

```tsx
  /**
   * @en-US Pop-up window of new window
   * @zh-CN æ–°å»ºçª—å£çš„å¼¹çª—
   *  */
  const [createModalOpen, handleModalOpen] = useState<boolean>(false);
	
 	const columns: ProColumns<API.InterfaceInfo>[] = [
    {
      title: 'id',
      dataIndex: 'id',
      valueType: 'index',
    },
   // ...
  ]

	// ...
	<CreateModal
    columns={columns}
    onCancel={() => handleModalOpen(false)}
    onSubmit={() => {}}
    open={createModalOpen}
  />
```

æµ‹è¯•ä¸€ä¸‹

![image-20230113164234500](å¼€å‘æ–‡æ¡£.assets/image-20230113164234500.png)

emmmm... è¿™æ˜¯ä»€ä¹ˆç©æ„??

æŸ¥è¯¢å®˜æ–¹æ–‡æ¡£å¯çŸ¥ï¼Œè¿™æ˜¯ProTableçš„é»˜è®¤type æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç»™å®ƒæŒ‡å®šä¸€ä¸ªformçš„type

```tsx
const CreateModal: React.FC<Props> = (props) => {
  const { columns, open, onCancel } = props;
  return (
    <Modal open={open} onCancel={() => onCancel?.()}>
      <ProTable columns={columns} type={'form'} />
    </Modal>
  );
};
```

å†æµ‹è¯•ä¸€ä¸‹å°±æ­£å¸¸å•¦~

![image-20230113164846052](å¼€å‘æ–‡æ¡£.assets/image-20230113164846052.png)

å‘ç°åˆ›å»ºæ—¶é—´ã€æ›´æ–°æ—¶é—´æˆ‘ä»¬å¹¶ä¸éœ€è¦ã€‚å¢åŠ hideInFormå±æ€§

```tsx
    {
      title: 'åˆ›å»ºæ—¶é—´',
      dataIndex: 'createTime',
      valueType: 'dateTime',
      hideInForm: true,
    },
    {
      title: 'æ›´æ–°æ—¶é—´',
      dataIndex: 'updateTime',
      valueType: 'dateTime',
      hideInForm: true,
    },
```



#### 2.2. è¯·æ±‚åç«¯

**å…ˆç®€å•å¤„ç†ä¸€ä¸‹è¯·æ±‚æŠ¥é”™çš„æƒ…å†µ**

æ‰¾åˆ°`src/requestConfig.ts` ä¿®æ”¹ä¸€ä¸‹å“åº”æ‹¦æˆªå™¨

```typescript
  // å“åº”æ‹¦æˆªå™¨
  responseInterceptors: [
    (response) => {
      // æ‹¦æˆªå“åº”æ•°æ®ï¼Œè¿›è¡Œä¸ªæ€§åŒ–å¤„ç†
      const { data } = response as unknown as ResponseStructure;
      console.log('data', data);
      if (data.code !== 0) {
        throw new Error(data.message);
      }
      return response;
    },
  ],
```

å†åœ¨`interfaceinfo/index.tsxä¸­`æ–°å¢è¯·æ±‚åç«¯çš„æ–¹æ³•

```tsx
  const handleAddInterfaceInfo = async (fields: API.InterfaceInfoAddRequest) => {
    const hide = message.loading('æ­£åœ¨æ·»åŠ ');
    try {
      await addInterfaceInfoUsingPOST({ ...fields });
      hide();
      message.success('åˆ›å»ºæˆåŠŸ!');
      // å…³é—­Modal
      handleModalOpen(false);
      return true;
    } catch (error: any) {
      hide();
      console.log(error);
      message.error('åˆ›å»ºå¤±è´¥!' + error.message);
      return false;
    }
  };

// ...

<CreateModal
  columns={columns}
  onCancel={() => handleModalOpen(false)}
  onSubmit={(values) => handleAddInterfaceInfo(values)}
  open={createModalOpen}
  />
```

å†ä¿®æ”¹`CreateModal.tsx`

```tsx
const CreateModal: React.FC<Props> = (props) => {
  const { columns, open, onCancel, onSubmit } = props;
  return (
    <Modal title={'æ–°å»ºæ¥å£'} open={open} onCancel={() => onCancel?.()}>
      <ProTable columns={columns} type={'form'} onSubmit={async (value) => onSubmit?.(value)} />
    </Modal>
  );
};
```



æµ‹è¯•æ·»åŠ æˆåŠŸ

![image-20230113183349785](å¼€å‘æ–‡æ¡£.assets/image-20230113183349785.png)





### 3ã€ç¼–è¾‘æ¥å£ä¿¡æ¯

---

å…ˆæŠŠModalçš„footerå¹²æ‰   footer={null}

```ts
<Modal title={'æ›´æ–°æ¥å£'} footer={null} open={open} onCancel={() => onCancel?.()}>
		  // ...
  );
```



#### 3.1. è¡¨å•æ¨¡å—

æ–°å»ºæ–‡ä»¶`src/pages/InterfaceInfo/components/UpdateModal.tsx`

è¿™é‡Œä½¿ç”¨çš„useRefã€formRefå‚è€ƒäº†[å®˜æ–¹æ–‡æ¡£](https://procomponents.ant.design/components/table#%E9%80%9A%E8%BF%87-formref-%E6%9D%A5%E6%93%8D%E4%BD%9C%E6%9F%A5%E8%AF%A2%E8%A1%A8%E5%8D%95)

```tsx
import { Modal } from 'antd';
import React, {useEffect, useRef} from 'react';
import { ProColumns, ProFormInstance, ProTable } from '@ant-design/pro-components';
import '@umijs/max';

export type Props = {
  value: API.InterfaceInfo;
  columns: ProColumns<API.InterfaceInfoUpdateRequest>[];
  onCancel: () => void;
  onSubmit: (values: API.InterfaceInfoUpdateRequest) => Promise<void>;
  open: boolean;
};

const UpdateModal: React.FC<Props> = (props) => {
  const { value, columns, open, onCancel, onSubmit } = props;

  const formRef = useRef<ProFormInstance>();

  useEffect(() => {
    if (formRef) {
      formRef.current?.setFieldsValue(value);
    }
  }, [value]);

  return (
    <Modal title={'æ›´æ–°æ¥å£'} footer={null} open={open} onCancel={() => onCancel?.()}>
      <ProTable
        columns={columns}
        formRef={formRef}
        type={'form'}
        onSubmit={async (value) => onSubmit?.(value)}
        // è®¾ç½®é»˜è®¤å€¼
        form={{ initialValues: value }}
      />
    </Modal>
  );
};

export default UpdateModal;

```



#### 3.2. è¯·æ±‚åç«¯

åœ¨`interfaceinfo/index.tsx`ä¸­æ–°å¢è¯·æ±‚åç«¯çš„æ–¹æ³•

```tsx
  /**
   * @en-US Update InterfaceInfo
   * @zh-CN æ›´æ–°æ¥å£ä¿¡æ¯
   *
   * @param updateValue
   */
  const handleUpdateInterfaceInfo = async (updateValue: API.InterfaceInfoUpdateRequest) => {
    const hide = message.loading('æ­£åœ¨æ›´æ–°');
    try {
      let res = await updateInterfaceInfoUsingPOST({ ...updateValue });
      if (res.data) {
        hide();
        handleUpdateModalOpen(false);
        message.success('æ›´æ–°æˆåŠŸ!');
        return true;
      }
    } catch (error: any) {
      hide();
      message.error('æ›´æ–°å¤±è´¥!' + error.message);
      return false;
    }
  };      



// è¿™é‡Œçš„<UpdateModal/>ä»£ç æ˜¯åœ¨åŸæœ‰çš„ <UpdateForm/> åŸºç¡€ä¸Šé¢æ”¹çš„
<UpdateModal
        value={currentRow || {}}
        columns={columns}
        open={updateModalOpen}
        onSubmit={async (value) => {
          const success = await handleUpdateInterfaceInfo(value);
          if (success) {
            handleUpdateModalOpen(false);
            setCurrentRow(undefined);
            if (actionRef.current) {
              actionRef.current.reload();
            }
          }
        }}
        onCancel={() => {
          handleUpdateModalOpen(false);
          if (!showDetail) {
            setCurrentRow(undefined);
          }
        }}
      />
```

å‡ºé”™äº†ï¼ŒçŒœæµ‹æ˜¯Ant Design Proçš„é—®é¢˜ï¼ŒçŒœé”™äº†ï¼Œå…¶å®æ˜¯columnsä¸­çš„idçš„typeä¸ºindexçš„åŸå› ã€‚å¹¶æ²¡æœ‰idå­—æ®µï¼Œæ‰€ä»¥æˆ‘æ‰‹åŠ¨ç»™ä¸€ä¸‹

![image-20230113222955554](å¼€å‘æ–‡æ¡£.assets/image-20230113222955554.png)

ä¿®æ”¹ä»£ç å¦‚ä¸‹

```tsx
/**
   * @en-US Update InterfaceInfo
   * @zh-CN æ›´æ–°æ¥å£ä¿¡æ¯
   *
   * @param fields
   */
  const handleUpdateInterfaceInfo = async (fields: API.InterfaceInfoUpdateRequest) => {
    const hide = message.loading('æ­£åœ¨æ›´æ–°');
    try {
      if(!currentRow){
        return false;
      }
      let res = await updateInterfaceInfoUsingPOST({
        // å› ä¸ºcolumnsä¸­çš„id valueTypeä¸ºindex ä¸ä¼šä¼ é€’ æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨èµ‹å€¼id
        id: currentRow.id,
        ...fields,
      });
      if (res.data) {
        hide();
        handleUpdateModalOpen(false);
        message.success('æ›´æ–°æˆåŠŸ!');
        // åˆ·æ–°é¡µé¢
        actionRef.current?.reload();
        return true;
      }
    } catch (error: any) {
      hide();
      message.error('æ›´æ–°å¤±è´¥!' + error.message);
      return false;
    }
  };

```

æµ‹è¯•æ›´æ–°æˆåŠŸ~





### 4ã€åˆ é™¤æ¥å£ä¿¡æ¯

---

**åˆ é™¤æŒ‰é’®**

```tsx
// åœ¨columnsä¸­æ·»åŠ åˆ é™¤æŒ‰é’®	
{
      title: 'æ“ä½œ',
      dataIndex: 'option',
      valueType: 'option',
      render: (_, record) => [
        <a
          key="config"
          onClick={() => {
            handleUpdateModalOpen(true);
            setCurrentRow(record);
          }}
        >
          ç¼–è¾‘
        </a>,
        <a
          key="delete"
          onClick={() => {
            handleRemoveInterfaceInfo(record);
          }}
        >
          åˆ é™¤
        </a>,
      ],
    },
```

**è°ƒç”¨æ–¹æ³•**

```tsx
  const handleRemoveInterfaceInfo = async (record: API.InterfaceInfo) => {
    const hide = message.loading('æ­£åœ¨åˆ é™¤');
    if (!record) return true;
    try {
      await deleteInterfaceInfoUsingPOST({
        id: record.id,
      });
      hide();
      message.success('åˆ é™¤æˆåŠŸ!');
      // åˆ·æ–°é¡µé¢
      actionRef.current?.reload();
      return true;
    } catch (error: any) {
      hide();
      message.error('åˆ é™¤å¤±è´¥!' + error.message);
      return false;
    }
  };
```



æµ‹è¯•åˆ é™¤æˆåŠŸ~

![image-20230114154218713](å¼€å‘æ–‡æ¡£.assets/image-20230114154218713.png)



## ä¸‰ã€APIå¼€å‘

### 1ã€æ¨¡æ‹Ÿæ¥å£

**åˆ›å»ºé¡¹ç›®**

å¿«é€Ÿåˆ›å»ºä¸€ä¸ªspring Booté¡¹ç›® å‹¾é€‰

SpringWebã€Lombokã€Spring Boot DevTools



**æä¾›ä¸‰ä¸ªæ¨¡æ‹Ÿæ¥å£**

æ¥å£å¤§ä½“å†…å®¹

1.  GET æ¥å£
2.  POST æ¥å£ï¼ˆurlä¼ å‚ï¼‰
3.  POSTæ¥å£ï¼ˆRestfulï¼‰

ç®€å•çš„é¡¹ç›®ç»“æ„

```java
package com.ohh.linksauceinterface.controller;

import com.ohh.linksauceinterface.modal.User;
import org.springframework.web.bind.annotation.*;

/**
 * åç§°API
 */
@RestController
@RequestMapping("/name")
public class NameController {

    @GetMapping("/")
    public String getNameByGet(String name) {
        return "GET ä½ çš„åå­—æ˜¯" + name;
    }

    @PostMapping("/")
    public String getNameByPost(@RequestParam String name) {
        return "POST ä½ çš„åå­—æ˜¯" + name;
    }

    @PostMapping("/user")
    public String getUsernameByPost(@RequestBody User user) {
        return "POST ä½ çš„ç”¨æˆ·åæ˜¯" + user.getUsername();
    }


}
```

application.ymlé…ç½®ä¸€ä¸‹ç«¯å£ã€ç„¶åæŒ‡å®šä¸€ä¸‹å…¨å±€æ¥å£çš„åœ°å€

```yml
server:
  port: 8123
  servlet:
    context-path: /api
```



### 2ã€è°ƒç”¨æ¥å£

**å‡ ç§HTTPçš„è°ƒç”¨æ–¹å¼ï¼š**

1. HttpClient
2. RestTemplate
3. ç¬¬ä¸‰æ–¹åº“ï¼ˆOKHttpï¼ŒHutoolï¼‰

è¿™é‡Œæˆ‘ä½¿ç”¨äº†**Hutool**è°ƒç”¨		[hutoolæ–‡æ¡£](https://hutool.cn/docs/#/)

pomä¸­æ·»åŠ 

```xml
<dependency>
    <groupId>cn.hutool</groupId>
    <artifactId>hutool-all</artifactId>
    <version>5.8.11</version>
</dependency>
```

æŸ¥çœ‹æ–‡æ¡£ä¸­çš„Httpè¯·æ±‚ç›¸å…³ç”¨æ³• ç¼–å†™`linkSauceClient`

```java
package com.ohh.linksauceinterface.client;

import cn.hutool.http.HttpRequest;
import cn.hutool.http.HttpResponse;
import cn.hutool.http.HttpUtil;
import cn.hutool.json.JSONUtil;
import com.ohh.linksauceinterface.modal.User;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;

import java.util.HashMap;

public class linkSauceClient {

    public String getNameByGet(String name) {
        // å¯ä»¥å•ç‹¬ä¼ å…¥httpå‚æ•°ï¼Œè¿™æ ·å‚æ•°ä¼šè‡ªåŠ¨åšURLç¼–ç ï¼Œæ‹¼æ¥åœ¨URLä¸­
        HashMap<String, Object> paramMap = new HashMap<>();
        paramMap.put("name", name);
        String result = HttpUtil.get("http://localhost:8123/api/name/", paramMap);
        System.out.println(result);
        return result;
    }

    public String getNameByPost(@RequestParam String name) {
        // å¯ä»¥å•ç‹¬ä¼ å…¥httpå‚æ•°ï¼Œè¿™æ ·å‚æ•°ä¼šè‡ªåŠ¨åšURLç¼–ç ï¼Œæ‹¼æ¥åœ¨URLä¸­
        HashMap<String, Object> paramMap = new HashMap<>();
        paramMap.put("name", name);
        String result = HttpUtil.post("http://localhost:8123/api/name/", paramMap);
        System.out.println(result);
        return result;
    }

    public String getUsernameByPost(@RequestBody User user) {
        String json = JSONUtil.toJsonStr(user);
        HttpResponse httpResponse = HttpRequest.post("http://localhost:8123/api/name/user")
                .body(json)
                .execute();
        System.out.println(httpResponse.getStatus());
        String result = httpResponse.body();
        System.out.println(result);
        return result;
    }

}
```

åˆ›å»ºæµ‹è¯•ç±»è°ƒç”¨æµ‹è¯•

![image-20240402233418619](å¼€å‘æ–‡æ¡£.assets/image-20240402233418619.png)



## å››ã€APIç­¾åè®¤è¯

**æœ¬è´¨ï¼š**

1.  ç­¾å‘ç­¾å
2.  ä½¿ç”¨ç­¾åï¼ˆæ ¡éªŒç­¾åï¼‰



**ä½œç”¨ï¼š**

ä¿è¯å®‰å…¨æ€§ï¼Œä¸èƒ½éšä¾¿ä¸€ä¸ªäººå°±å¯ä»¥è°ƒç”¨



**å®ç°æ–¹æ³•ï¼š**

-   **accessKey** 	è°ƒç”¨çš„æ ‡è¯†ï¼ˆå¤æ‚ï¼Œæ— åºï¼Œæ— è§„å¾‹ï¼‰
-   **secretKey**	å¯†é’¥ ï¼ˆå¤æ‚ï¼Œæ— åºï¼Œæ— è§„å¾‹ï¼‰	

ç±»ä¼¼**ç”¨æˆ·å**å’Œ**å¯†ç **ï¼ŒåŒºåˆ«ï¼šaccessKeyã€secretKeyæ˜¯**æ— çŠ¶æ€**çš„

åƒä¸‡ä¸èƒ½æŠŠå¯†é’¥ç›´æ¥åœ¨æœåŠ¡å™¨é—´è¿›è¡Œä¼ é€’ï¼Œæœ‰å¯èƒ½è¢«æ‹¦æˆª

åŠ å¯†çœ‹ç¬¬äºŒç‚¹



### 1ã€ä¿®æ”¹æ•°æ®åº“

ç”±äºæˆ‘ä»¬çš„**userè¡¨**é‡Œé¢æ²¡æœ‰**access_key**ã€**secret_key** æ‰€ä»¥æˆ‘ä»¬è¦ä¿®æ”¹æ•°æ®åº“è¡¨

```sql
create table if not exists user
(
    id            bigint auto_increment comment 'id' primary key,
    user_name     varchar(256)                           null comment 'ç”¨æˆ·æ˜µç§°',
    user_account  varchar(256)                           not null comment 'è´¦å·',
    user_avatar   varchar(1024)                          null comment 'ç”¨æˆ·å¤´åƒ',
    gender        tinyint                                null comment 'æ€§åˆ«',
    user_role     varchar(256) default 'user'            not null comment 'ç”¨æˆ·è§’è‰²ï¼šuser / admin',
    user_password varchar(512)                           not null comment 'å¯†ç ',
    access_key    varchar(256)                           null comment 'access_key',
    secret_key    varchar(256)                           null comment 'secret_key',
    create_time   datetime     default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    update_time   datetime     default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    is_delete     tinyint      default 0                 not null comment 'æ˜¯å¦åˆ é™¤',
    constraint uni_user_account
        unique (user_account)
) comment 'ç”¨æˆ·';
```

ç›´æ¥dropæ‰ä¹‹å‰çš„tableé‡æ–°å»ºè¡¨ï¼Œæ’å…¥ä¸€æ¡æµ‹è¯•æ•°æ®ã€‚

æ ‡å‡†çš„è¯ åº”è¯¥æ–°å»ºä¸€ä¸ªè¡¨ ä¸»è¦å­—æ®µä¸ºæ¥å£idã€ä½¿ç”¨ç”¨æˆ·idã€access_keyã€secret_keyç­‰ç­‰



### 2ã€åŠ å¯†

---

#### 2.1. åŠ å¯†æ–¹å¼

å°†accessKeyã€secretKeyæ”¾åœ¨Headeré‡Œæ˜æ–‡ä¼ é€’å®‰å…¨å—

ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå› ä¸ºæˆ‘ä»¬çš„**è¯·æ±‚å¯èƒ½è¢«äººæ‹¦æˆª**ï¼Œè€Œæˆ‘ä»¬æŠŠå¯†ç æ”¾è¿›è¯·æ±‚å¤´é‡Œé¢ï¼Œå¯èƒ½ä¼šè¢«åˆ«äººè·å–

> ä¸€èˆ¬æ˜¯æ ¹æ®å¯†é’¥ï¼Œç”Ÿæˆ**ç­¾åsign**

**åŠ å¯†æ–¹å¼**

1.  â€‹	å¯¹ç§°åŠ å¯†

2.  â€‹	éå¯¹ç§°åŠ å¯†

3.  â€‹	md5 ç­¾åï¼ˆä¸å¯è§£å¯†ï¼‰



**ç­¾åçš„åšæ³•**

å‡å¦‚ ï¼Œæˆ‘ä»¬æœ‰ç”¨æˆ·å‚æ•°ï¼Œæˆ‘ä»¬ç”¨å¯†é’¥ä¸ä»–æ‹¼æ¥ï¼Œç”¨ç­¾åç®—æ³•å¾—åˆ°ä¸€ä¸ªä¸å¯è§£å¯†çš„å€¼

â€‹			**ç”¨æˆ·å‚æ•° 	+	å¯†é’¥	=>	ç­¾åç”Ÿæˆç®—æ³•ï¼ˆMD5,HMac,Sha1) 	=>	ä¸å¯è§£å¯†çš„å€¼**

ä¾‹å­ï¼š	xuan 	+	abc	=>	7e7b9583aa0bc3e834fe8bcaebda38b5ï¼ˆè¿™é‡Œæ˜¯æˆ‘éšä¾¿è¾“çš„ï¼Œå¾—åˆ°çš„å€¼æ˜¯éšæœºçš„ï¼‰

æ€ä¹ˆçŸ¥é“ç­¾åå¯¹ä¸å¯¹ï¼Ÿ

æœåŠ¡ç«¯ç”¨ä¸€æ¨¡ä¸€æ ·çš„å‚æ•°å’Œç®—æ³•å»ç”Ÿæˆç­¾åï¼Œåªè¦å’Œç”¨æˆ·ä¼ çš„ä¸€è‡´ï¼Œå°±è¡¨ç¤ºå¯†é’¥ä¸€è‡´



**æ€ä¹ˆé˜²é‡æ”¾ï¼Ÿ**

åŠ nonceéšæœºæ•°	åªèƒ½ç”¨ä¸€æ¬¡

æœåŠ¡ç«¯è¦ä¿å­˜ç”¨è¿‡çš„éšæœºæ•°	

åŠ timestamp æ—¶é—´æˆ³ï¼Œæ ¡éªŒå®ƒçš„æœ‰æ•ˆæœŸ



ç»¼ä¸Šæ‰€å±

**ä¼ é€’çš„å‚æ•°**

1.  accessKey
2.  sign ï¼ˆç”±accessKey(æˆ–è€…ä½¿ç”¨ç”¨æˆ·è¯·æ±‚å‚æ•°bodyç­‰)ã€secretKeyåŠ å¯†è€Œæ¥ï¼‰
3.  nonceéšæœºæ•°
4.  timestamp
5.  bodyï¼ˆç”¨æˆ·è¯·æ±‚å‚æ•° å¯è¦å¯ä¸è¦ï¼‰

**APIç­¾åè®¤è¯æ˜¯ä¸€ä¸ªå¾ˆçµæ´»çš„è®¾è®¡ï¼Œå…·ä½“è¦æœ‰å“ªäº›å‚æ•°ï¼Œå°½é‡æœåŠ¡ç«¯è°ƒç”¨ï¼Œå‚æ•°åå¦‚ä½•è¦æ ¹æ®åœºæ™¯æ¥ã€‚**



#### 2.2. åŠ å¯†ä»£ç 

æˆ‘è¿™é‡Œç›´æ¥ä½¿ç”¨äº†bodyã€å’ŒsecretKeyè¿›è¡ŒåŠ å¯†

å…ˆåˆ›å»ºä¸€ä¸ªåŠ å¯†ç­¾åç±»`SignUtil.java`

```java
package com.ohh.linksauceinterface.utils;

import cn.hutool.crypto.digest.DigestAlgorithm;
import cn.hutool.crypto.digest.Digester;

/**
 * ç­¾åå·¥å…·
 */
public class SignUtils {
    /**
     * ç”Ÿæˆç­¾å
     *
     * @param body
     * @param secretKey
     * @return
     */
    public static String genSign(String body, String secretKey) {
        Digester md5 = new Digester(DigestAlgorithm.SHA256);
        String content = body + "." + secretKey;
        return md5.digestHex(content);
    }
}

```



åœ¨Clientç±»ä¸­æ–°å¢æ„é€ Headerçš„æ–¹æ³•

```java
public class linkSauceClient {

    private String accessKey;
    private String secretKey;
  
	// ...

 private Map<String, String> getHeaderMap(String body) {
        Map<String, String> hashMap = new HashMap<>();
        hashMap.put("accessKey", accessKey);
        // ä¸èƒ½ç›´æ¥å‘é€
        // hashMap.put("secretKey", secretKey);
        hashMap.put("nonce", RandomUtil.randomNumbers(4));
        hashMap.put("body", body);
        hashMap.put("timestamp", String.valueOf(System.currentTimeMillis() / 1000));
        hashMap.put("sign", genSign(body, secretKey));
        return hashMap;
    }

    public String getUsernameByPost(@RequestBody User user) {
        String json = JSONUtil.toJsonStr(user);
        HttpResponse httpResponse = HttpRequest.post("http://localhost:8123/api/name/user")
                .addHeaders(getHeaderMap(json))
                .body(json)
                .execute();
        System.out.println(httpResponse.getStatus());
        String result = httpResponse.body();
        System.out.println(result);
        return result;
    }

}
```



è°ƒç”¨APIçš„æ—¶å€™åŠ å¯†ä»£ç å·²ç»å†™å¥½äº†ï¼Œæ˜¾ç„¶æˆ‘ä»¬åœ¨APIä¸­éœ€è¦ç”¨åŒæ ·çš„æ–¹æ³•æ¥éªŒè¯åŠ å¯†ã€‚è¿™é‡Œä»¥æºå¸¦JSON bodyçš„POSTè¯·æ±‚ä¸ºä¾‹

```java
package com.ohh.linksauceinterface.controller;

import com.ohh.linksauceinterface.modal.User;
import com.ohh.linksauceinterface.utils.SignUtils;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;

/**
 * åç§°API
 */
@RestController
@RequestMapping("/name")
public class NameController {

    @GetMapping("/")
    public String getNameByGet(String name) {
        return "GET ä½ çš„åå­—æ˜¯" + name;
    }

    @PostMapping("/")
    public String getNameByPost(@RequestParam String name) {
        return "POST ä½ çš„åå­—æ˜¯" + name;
    }

    @PostMapping("/user")
    public String getUsernameByPost(@RequestBody User user, HttpServletRequest request) {
        String accessKey = request.getHeader("accessKey");
        String nonce = request.getHeader("nonce");
        String timestamp = request.getHeader("timestamp");
        String sign = request.getHeader("sign");
        String body = request.getHeader("body");
        // todo å®é™…å¼€å‘åº”å»æ•°æ®åº“ä¸­æŸ¥çœ‹æ˜¯å¦å·²åˆ†é…ç»™ç”¨æˆ·
        if (!accessKey.equals("ohh")) {
            throw new RuntimeException("æ— æƒé™è®¿é—®");
        }
        if (Long.parseLong(nonce) > 10000) {
            throw new RuntimeException("æ— æƒé™è®¿é—®");
        }
        // todo æ—¶é—´å’Œå½“å‰æ—¶é—´ä¸èƒ½è¶…è¿‡5åˆ†é’Ÿ
        // if (timestamp){
        //
        // }

        // todo å®é™…æƒ…å†µæ˜¯ä»æ•°æ®åº“ä¸­æŸ¥secretKey
        String serverSign = SignUtils.genSign(body, "abcdefgh");
        if (!sign.equals(serverSign)) {
            throw new RuntimeException("ç­¾åé”™è¯¯");
        }

        return "POST ä½ çš„ç”¨æˆ·åæ˜¯" + user.getUsername();
    }


}

```

è¿›è¡Œæµ‹è¯•secretKey = "abc" å¯ä»¥æ­£ç¡®è®¿é—®ï¼Œå½“secreté”™è¯¯æ—¶è¿”å›æ— æƒé™ï½



## äº”ã€å¼€å‘ä¸€ä¸ªSDKï¼ˆstarterï¼‰

ç†æƒ³æƒ…å†µï¼šå¼€å‘è€…åªéœ€è¦å…³å¿ƒè°ƒç”¨å“ªäº›æ¥å£ã€ä¼ é€’å“ªäº›å‚æ•°ã€‚å°±è·Ÿè°ƒç”¨è‡ªå·±å†™çš„ä»£ç ä¸€æ ·ç®€å•ã€‚

> å¼€å‘starterçš„å¥½å¤„ï¼šå¼€å‘è€…å¼•å…¥ä¹‹åï¼Œå¯ä»¥ç›´æ¥åœ¨application.ymlä¸­å†™é…ç½®ï¼Œè‡ªåŠ¨åˆ›å»ºå®¢æˆ·ç«¯

### 1ã€æ–°å»ºé¡¹ç›®

åˆ›å»ºä¸€ä¸ª`linksauce-client-sdk`çš„springbooté¡¹ç›® å‹¾é€‰lombokã€Spring Configuration Processor

ï¼ˆä½œç”¨ï¼šè‡ªåŠ¨ç”Ÿæˆé…ç½®çš„ä»£ç æç¤ºï¼‰

ç„¶åå¤„ç†`pom.xml`  <build></build>è¿™ä¸ª<font color='red'>ä¸€å®šéœ€è¦åˆ é™¤</font>å› ä¸ºè¿™ä¸ªæ˜¯mavençš„æ„å»ºé¡¹ç›®æˆå¯è¿è¡ŒjaråŒ…ã€‚ç°åœ¨æ˜¯åˆ¶ä½œstarterä¾èµ–åŒ…

![image-20230116142827466](å¼€å‘æ–‡æ¡£.assets/image-20230116142827466-17121502607301.png)



### 2ã€ç¼–å†™é…ç½®ç±»

æˆ‘ä»¬ä¸éœ€è¦spring bootå¯åŠ¨ç±»ï¼Œå°†å…¶åˆ å»ã€‚

ç„¶åå°†ä¹‹å‰ç¼–å†™å¥½çš„clientã€utilã€modelç²˜è´´è¿‡æ¥

![image-20240403211904794](å¼€å‘æ–‡æ¡£.assets/image-20240403211904794.png)

å†æ–°å»ºé…ç½®ç±»`LinkSauceClientConfig`

```java
@Configuration
@ConfigurationProperties("linksauce.client")
@Data
@ComponentScan
public class LinkSauceClientConfig {

    private String accessKey;
    private String secretKey;

    @Bean
    public linkSauceClient linkSauceClient() {
        return new linkSauceClient(accessKey, secretKey);
    }

}
```



### 3ã€æŒ‡å®šé…ç½®ç±»

æ–°å»º`resources/META-INF/spring.factories`å¹¶æŒ‡å®š

```properties
# spring boot starter
org.springframework.boot.autoconfigure.EnableAutoConfiguration=com.xuan.XuanApiClientConfig
```

![image-20240403212126780](å¼€å‘æ–‡æ¡£.assets/image-20240403212126780.png)



### 4ã€å‘å¸ƒstarter

åŒå‡»Maven lifecycleä¸‹çš„**install**æˆ–è€…å‘½ä»¤è¡Œ`mvn install`

![image-20240403212248335](å¼€å‘æ–‡æ¡£.assets/image-20240403212248335.png)



### 5ã€æµ‹è¯•

**å¼•å…¥ä¾èµ–**

å›åˆ°`linksauce-Interface`é¡¹ç›®ï¼ŒæŠŠä¹‹å‰çš„**client**ã€**util**ã€**model**å…¨éƒ¨åˆ æ‰ã€‚ç„¶ååœ¨**pom**ä¸­å¼•å…¥æˆ‘ä»¬åˆšåˆšåˆ¶ä½œå¥½çš„starter

<font color='red'>æ³¨æ„ï¼š</font>è¿™é‡Œèƒ½ç›´æ¥å¼•å…¥ï¼Œæ˜¯å› ä¸ºåˆšåˆšæˆ‘ä»¬installçš„stateråœ¨æˆ‘ä»¬çš„æœ¬åœ°ï¼Œå¯ä»¥å‘å¸ƒåˆ°Mavenä»“åº“æˆ–è€…æä¾›jaråŒ…ä¾›å¤§å®¶ä½¿ç”¨ã€‚

```xml
<!--è‡ªå·±åˆ¶ä½œçš„starter-->
<dependency>
  <groupId>com.linksauce</groupId>
  <artifactId>linksauce-client-sdk</artifactId>
  <version>0.0.1</version>
</dependency>
```



**é…ç½®ä¿¡æ¯**

![image-20240403212604953](å¼€å‘æ–‡æ¡£.assets/image-20240403212604953.png)

> åœ¨ymlæ–‡ä»¶ä¸­é…ç½®çš„æ—¶å€™æœ‰æç¤ºå°±æ˜¯ä¹‹å‰å¼•å…¥çš„Spring Configuration Processorå‘æŒ¥çš„ä½œç”¨ã€‚



åœ¨æµ‹è¯•ç±»ä½¿ç”¨@Resourceæ³¨å…¥linkSauceClientè¿›è¡Œæµ‹è¯•

![image-20240403212738869](å¼€å‘æ–‡æ¡£.assets/image-20240403212738869.png)



## å…­ã€æ¥å£å‘å¸ƒ/ä¸‹çº¿

è¿™ä¸ªåŠŸèƒ½é¦–å…ˆæ˜¯ä»…ç®¡ç†å‘˜ä½¿ç”¨çš„

**å‘å¸ƒæ¥å£**

1.  æ ¡éªŒè¯¥æ¥å£æ˜¯å¦å­˜åœ¨
2.  åˆ¤æ–­æ¥å£æ˜¯å¦å¯ä»¥è¢«è°ƒç”¨
3.  ä¿®æ”¹æ•°æ®åº“æ¥å£å­—æ®µä¸º1

**ä¸‹çº¿æ¥å£**

1.  æ ¡éªŒè¯¥æ¥å£æ˜¯å¦å­˜åœ¨
2.  ä¿®æ”¹æ•°æ®åº“æ¥å£å­—æ®µä¸º 0

### 1ã€åç«¯



1.   **é€šç”¨è¯·æ±‚ç±»**

     ä¸Šä¸‹çº¿éƒ½æ˜¯é€šè¿‡idæ¥æ§åˆ¶çš„

     ```java
     /**
      * é€šè¿‡idå‘é€è¯·æ±‚
      *
      * @author ohh
      */
     @Data
     public class IdRequest implements Serializable {
         /**
          * id
          */
         private Long id;
     
         private static final long serialVersionUID = 1L;
     }
     ```

2.   **æšä¸¾ç±»**

     ä½¿ç”¨æšä¸¾ç±»æ¥è¡¨ç¤ºä¸Šçº¿/ä¸‹çº¿çŠ¶æ€

     ```java
     package com.ohh.project.model.enums;
     
     import java.util.Arrays;
     import java.util.List;
     import java.util.stream.Collectors;
     
     /**
      * æ¥å£ä¿¡æ¯çŠ¶æ€æšä¸¾
      *
      * @author ohh
      */
     public enum InterfaceInfoStatusEnum {
     
         OFFLINE("å…³é—­", 0),
         ONLINE("ä¸Šçº¿", 1);
     
         private final String text;
     
         private final int value;
     
         InterfaceInfoStatusEnum(String text, int value) {
             this.text = text;
             this.value = value;
         }
     
         /**
          * è·å–å€¼åˆ—è¡¨
          *
          * @return
          */
         public static List<Integer> getValues() {
             return Arrays.stream(values()).map(item -> item.value).collect(Collectors.toList());
         }
     
         public int getValue() {
             return value;
         }
     
         public String getText() {
             return text;
         }
     }
     ```

3.   **åœ¨controlleré‡Œç¼–å†™ä¸Šä¸‹çº¿ä»£ç **

     <font color='red'>è¿™é‡Œæœ‰ä¸ªTODO</font> åˆ¤æ–­è¯¥æ¥å£æ˜¯å¦å¯ä»¥è°ƒç”¨æ—¶ï¼Œç”±`linksauceClient`å›ºå®šæ–¹æ³•åæ”¹ä¸ºæ ¹æ®æµ‹è¯•åœ°å€æ¥è°ƒç”¨

     ```java
     package com.ohh.project.controller;
     
     import ...
     
     /**
      * æ¥å£ç®¡ç†
      *
      * @author ohh
      */
     @RestController
     @RequestMapping("/interfaceInfo")
     @Slf4j
     public class InterfaceInfoController {
     
         @Resource
         private InterfaceInfoService interfaceInfoService;
     
         @Resource
         private UserService userService;
     
         @Resource
         private linkSauceClient linkSauceClient;
     
       // ...
      
         /**
          * å‘å¸ƒ
          *
          * @param idRequest
          * @param request
          * @return
          */
         @PostMapping("/online")
         @AuthCheck(mustRole = "admin")
         public BaseResponse<Boolean> onlineInterfaceInfo(@RequestBody IdRequest idRequest, HttpServletRequest request) {
     
             if (idRequest == null || idRequest.getId() <= 0) {
                 throw new BusinessException(ErrorCode.PARAMS_ERROR);
             }
             long id = idRequest.getId();
             // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
             InterfaceInfo oldInterfaceInfo = interfaceInfoService.getById(id);
             if (oldInterfaceInfo == null) {
                 throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);
             }
             // åˆ¤æ–­è¯¥æ¥å£æ˜¯å¦å¯ä»¥è°ƒç”¨
             com.linksauce.linksauceclientsdk.model.User user = new com.linksauce.linksauceclientsdk.model.User();
             user.setUsername("test");
             String username = linkSauceClient.getNameByPostWithJson(user);
             if (StringUtils.isBlank(username)) {
                 throw new BusinessException(ErrorCode.SYSTEM_ERROR, "æ¥å£éªŒè¯å¤±è´¥");
             }
             // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ä¿®æ”¹
             InterfaceInfo interfaceInfo = new InterfaceInfo();
             interfaceInfo.setId(id);
             interfaceInfo.setStatus(InterfaceInfoStatusEnum.ONLINE.getValue());
             boolean result = interfaceInfoService.updateById(interfaceInfo);
             return ResultUtils.success(result);
         }
     
         /**
          * ä¸‹çº¿
          *
          * @param idRequest
          * @param request
          * @return
          */
         @PostMapping("/offline")
         @AuthCheck(mustRole = "admin")
         public BaseResponse<Boolean> offlineInterfaceInfo(@RequestBody IdRequest idRequest, HttpServletRequest request) {
             if (idRequest == null || idRequest.getId() <= 0) {
                 throw new BusinessException(ErrorCode.PARAMS_ERROR);
             }
             long id = idRequest.getId();
             // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
             InterfaceInfo oldInterfaceInfo = interfaceInfoService.getById(id);
             if (oldInterfaceInfo == null) {
                 throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);
             }
     
             // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ä¿®æ”¹
             InterfaceInfo interfaceInfo = new InterfaceInfo();
             interfaceInfo.setId(id);
             interfaceInfo.setStatus(InterfaceInfoStatusEnum.OFFLINE.getValue());
             boolean result = interfaceInfoService.updateById(interfaceInfo);
             return ResultUtils.success(result);
         }
     }
     ```

4.   **æƒé™æ§åˆ¶**

     è¿™é‡Œæ·»åŠ æƒé™æ ¡éªŒï¼Œè¿™é‡Œç”¨åˆ°**@AuthCheck(mustRole = "admin")**çš„åˆ‡é¢æ³¨è§£ï¼Œå¯¹åº”çš„å®ç°æ–¹æ³•åœ¨`aop/AuthInterceptor`

     ```java
     package com.ohh.project.annotation;
     
     // import ...
     
     /**
      * æƒé™æ ¡éªŒ
      *
      * @author ohh
      */
     @Target(ElementType.METHOD)
     @Retention(RetentionPolicy.RUNTIME)
     public @interface AuthCheck {
     
         /**
          * æœ‰ä»»ä½•ä¸€ä¸ªè§’è‰²
          *
          * @return
          */
         String[] anyRole() default "";
     
         /**
          * å¿…é¡»æœ‰æŸä¸ªè§’è‰²
          *
          * @return
          */
         String mustRole() default "";
     
     }
     ```

     `aop/AuthInterceptor.java`

     ```java
     package com.ohh.project.aop;
     
     // import...
     
     import javax.annotation.Resource;
     import javax.servlet.http.HttpServletRequest;
     import java.util.Arrays;
     import java.util.List;
     import java.util.stream.Collectors;
     
     
     /**
      * æƒé™æ ¡éªŒ AOP
      *
      * @author ohh
      */
     @Aspect
     @Component
     public class AuthInterceptor {
     
         @Resource
         private UserService userService;
     
         /**
          * æ‰§è¡Œæ‹¦æˆª
          *
          * @param joinPoint
          * @param authCheck
          * @return
          */
         @Around("@annotation(authCheck)")
         public Object doInterceptor(ProceedingJoinPoint joinPoint, AuthCheck authCheck) throws Throwable {
             List<String> anyRole = Arrays.stream(authCheck.anyRole()).filter(StringUtils::isNotBlank).collect(Collectors.toList());
             String mustRole = authCheck.mustRole();
             RequestAttributes requestAttributes = RequestContextHolder.currentRequestAttributes();
             HttpServletRequest request = ((ServletRequestAttributes) requestAttributes).getRequest();
             // å½“å‰ç™»å½•ç”¨æˆ·
             User user = userService.getLoginUser(request);
             // æ‹¥æœ‰ä»»æ„æƒé™å³é€šè¿‡
             if (CollectionUtils.isNotEmpty(anyRole)) {
                 String userRole = user.getUserRole();
                 if (!anyRole.contains(userRole)) {
                     throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
                 }
             }
             // å¿…é¡»æœ‰æ‰€æœ‰æƒé™æ‰é€šè¿‡
             if (StringUtils.isNotBlank(mustRole)) {
                 String userRole = user.getUserRole();
                 if (!mustRole.equals(userRole)) {
                     throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
                 }
             }
             // é€šè¿‡æƒé™æ ¡éªŒï¼Œæ”¾è¡Œ
             return joinPoint.proceed();
         }
     }
     ```

     `userService.getLoginUser(request)`

     ```java
     /**
      * è·å–å½“å‰ç™»å½•ç”¨æˆ·
      *
      * @param request
      * @return
      */
     @Override
     public User getLoginUser(HttpServletRequest request) {
         // å…ˆåˆ¤æ–­æ˜¯å¦å·²ç™»å½•
         Object userObj = request.getSession().getAttribute(USER_LOGIN_STATE);
         User currentUser = (User) userObj;
         if (currentUser == null || currentUser.getId() == null) {
             throw new BusinessException(ErrorCode.NOT_LOGIN_ERROR);
         }
         // ä»æ•°æ®åº“æŸ¥è¯¢ï¼ˆè¿½æ±‚æ€§èƒ½çš„è¯å¯ä»¥æ³¨é‡Šï¼Œç›´æ¥èµ°ç¼“å­˜ï¼‰
         long userId = currentUser.getId();
         currentUser = this.getById(userId);
         if (currentUser == null) {
             throw new BusinessException(ErrorCode.NOT_LOGIN_ERROR);
         }
         return currentUser;
     }
     ```



### 2ã€å‰ç«¯

#### 2.1. æ·»åŠ å‘å¸ƒæŒ‰é’®å’Œä¸‹çº¿æŒ‰é’®

> Ant Design [Buttonçš„å®˜æ–¹æ–‡æ¡£](https://ant.design/components/button-cn)

å‘å¸ƒ/ä¸‹çº¿åšæˆä¸€ä¸ªæŒ‰é’®ã€‚é€šè¿‡statusæ¥åŠ¨æ€åˆ¤æ–­

```tsx
{
  title: 'æ“ä½œ',
  dataIndex: 'option',
  valueType: 'option',
  render: (_, record) => [
    <a
      key="config"
      onClick={() => {
        handleUpdateModalOpen(true);
        setCurrentRow(record);
      }}
    >
      ä¿®æ”¹
    </a>,
    record.status === 0 ? (
      <a
        key="config"
        onClick={() => {
          handleOnline(record);
        }}
      >
        å‘å¸ƒ
      </a>
    ) : null,
    record.status === 1 ? (
      <Button
        type="text"
        danger
        key="config"
        onClick={() => {
          handleOFFline(record);
        }}
      >
        ä¸‹çº¿
      </Button>
    ) : null,
    <Button
      type="text"
      danger
      key="delete"
      onClick={() => {
        handleRemoveInterfaceInfo(record);
      }}
    >
      åˆ é™¤
    </Button>,
  ],
},
```

è¿è¡Œæˆªå›¾ï¼š

![image-20240405145945492](å¼€å‘æ–‡æ¡£.assets/image-20240405145945492.png)

#### 2.2. ç¼–å†™å‘å¸ƒ/ä¸‹çº¿çš„æ–¹æ³•

<font color='red'>å› ä¸ºåç«¯æ–°å¢äº†ä»£ç ï¼Œæ‰€ä»¥è¿˜æ˜¯ä½¿ç”¨openapiè‡ªåŠ¨ç”Ÿæˆå‰ç«¯æ–¹æ³•</font>

è·Ÿä¹‹å‰æ“ä½œä¸€æ ·ï¼Œå»http://localhost:7529/api/v3/api-docså¤åˆ¶jsonåˆ°config/oneapi.json ç„¶åè¿è¡Œopenapi   

æ–°å¢æ–¹æ³•

```tsx
/**
 * å‘å¸ƒæ¥å£
 * @param selectedRows
 */
const handleOnline = async (record: API.IdRequest) => {
  const hide = message.loading('å‘å¸ƒä¸­');
  if (!record) return true;
  try {
    await onlineInterfaceInfoUsingPost({
      id: record.id,
    });
    hide();
    message.success('å‘å¸ƒæˆåŠŸ!');
    // åˆ·æ–°é¡µé¢
    actionRef.current?.reload();
    return true;
  } catch (error: any) {
    hide();
    message.error('å‘å¸ƒå¤±è´¥!' + error.message);
    return false;
  }
};

/**
 * ä¸‹çº¿æ¥å£
 * @param selectedRows
 */
const handleOFFline = async (record: API.IdRequest) => {
  const hide = message.loading('ä¸‹çº¿ä¸­');
  if (!record) return true;
  try {
    await offlineInterfaceInfoUsingPost({
      id: record.id,
    });
    hide();
    message.success('ä¸‹çº¿æˆåŠŸ!');
    // åˆ·æ–°é¡µé¢
    actionRef.current?.reload();
    return true;
  } catch (error: any) {
    hide();
    message.error('ä¸‹çº¿å¤±è´¥!' + error.message);
    return false;
  }
};
```



## ä¸ƒã€ç”¨æˆ·ä¸»é¡µ

>  å‰ç«¯æµè§ˆæ¥å£ï¼ŒæŸ¥çœ‹æ¥å£æ–‡æ¡£ï¼Œç”³è¯·ç­¾åï¼ˆæ³¨å†Œï¼‰

### 1ã€æµè§ˆæ¥å£

---

åœ¨`src/pages`ç›®å½•ä¸‹æ–°å»º**Index**ç›®å½•å¹¶æŠŠ`Welcome.tsx`æ‹–å…¥å…¶ä¸­

æ”¹åä¸º`index.tsx`



**é…ç½®è·¯ç”±**`routes.tsx`

```ts
  { name: 'ä¸»é¡µ', path: '/', icon: 'smile', component: './Index' },
```



**ç¼–å†™é¡µé¢**`Index/index.tsx`

>  å‚è€ƒ [Ant Design Listç»„ä»¶](https://ant.design/components/list-cn)

```tsx
import { listInterfaceInfoByPageUsingGet } from '@/services/linksauce-backend/interfaceInfoController';
import { PageContainer } from '@ant-design/pro-components';
import { List, message } from 'antd';
import React, { useEffect, useState } from 'react';

/**
 * ä¸»é¡µ
 * @constructor
 */
const Index: React.FC = () => {
  const [loading, setLoading] = useState(false);
  const [list, setList] = useState<API.InterfaceInfo[]>([]);
  const [total, setTotal] = useState<number>(0);

  const loadData = async (current = 1, pageSize = 10) => {
    setLoading(true);
    try {
      const res = await listInterfaceInfoByPageUsingGet({
        current,
        pageSize,
      });
      setList(res?.data?.records ?? []);
      setTotal(res?.data?.total ?? 0);
      setLoading(false);
    } catch (error: any) {
      setLoading(false);
      message.error('è¯·æ±‚å¤±è´¥,' + error.message);
    }
  };

  useEffect(() => {
    loadData();
  }, []);

  return (
    <PageContainer title={'åœ¨çº¿æ¥å£å¼€æ”¾å¹³å°'}>
      <List
        className="interfaceInfo-list"
        loading={loading}
        itemLayout="horizontal"
        dataSource={list}
        pagination={{
          showSizeChanger: true,
          total: total,
          showTotal(total, range) {
            return `${range[0]}-${range[1]} / ${total}`;
          },
          onChange(page, pageSize) {
            loadData(page, pageSize);
          },
        }}
        renderItem={(item) => {
          const apiLink = `/interface_info/${item.id}`;
          return (
            <List.Item actions={[<a key={item.id} href={apiLink}>æŸ¥çœ‹è¯¦æƒ…</a>]}>
              <List.Item.Meta
                title={<a href={apiLink}>{item.name}</a>}
                description={item.description}
              />
              <div>{item.method}</div>
            </List.Item>
          );
        }}
      />
    </PageContainer>
  );
};

export default Index;
```



**æ•ˆæœå¦‚ä¸‹**

![image-20240405162809892](å¼€å‘æ–‡æ¡£.assets/image-20240405162809892.png)



### 2ã€æŸ¥çœ‹æ¥å£æ–‡æ¡£

---

1.   **æ–°å»ºæ–‡ä»¶**

     åœ¨**pages**ä¸‹æ–°å»º `InterfaceInfo/index.tsx`

2.   **é…ç½®åŠ¨æ€è·¯ç”±**`routes.ts`

     > æŸ¥çœ‹ [umiæ–‡æ¡£](https://umijs.org/docs/guides/routes)

     ```ts
     {
       name: 'æŸ¥çœ‹æ¥å£',
       path: '/interface_info/:id',
       icon: 'smile',
       component: './InterfaceInfo',
       hideInMenu: true,
     },
     ```

3.   **ä¿®æ”¹è·³è½¬**

     ä¸»é¡µä»£ç ç‰‡æ®µä¿®æ”¹

     ```tsx
     return (
       <PageContainer title={'åœ¨çº¿æ¥å£å¼€æ”¾å¹³å°'}>
         <List
           className="interfaceInfo-list"
           loading={loading}
           itemLayout="horizontal"
           dataSource={list}
           pagination={{
             showSizeChanger: true,
             total: total,
             showTotal(total, range) {
               return `${range[0]}-${range[1]} / ${total}`;
             },
             onChange(page, pageSize) {
               loadData(page, pageSize);
             },
           }}
           renderItem={(item) => {
             const apiLink = `/interface_info/${item.id}`;
             return (
               <List.Item actions={[<a key={item.id} href={apiLink}>æŸ¥çœ‹è¯¦æƒ…</a>]}>
                 <List.Item.Meta
                   title={<a href={apiLink}>{item.name}</a>}
                   description={item.description}
                 />
                 <div>{item.method}</div>
               </List.Item>
             );
           }}
         />
       </PageContainer>
     );
     ```

     ç‚¹å‡»é¡µé¢å³å¯æŸ¥çœ‹è¯¦æƒ…

     ![image-20240405163340336](å¼€å‘æ–‡æ¡£.assets/image-20240405163340336.png)

4.   **ç¼–å†™`InterfaceInfo/index.tsx`**

     è¿™é‡Œéœ€è¦æŸ¥çœ‹Ant Designä¸­çš„**Card** å’Œ **Descriptions** ç»„ä»¶ 

     å·²ç»umiä¸­åŠ¨æ€è·¯ç”±å¦‚ä½•è·å–è·¯å¾„ä¸­çš„id

     **ä»£ç å¦‚ä¸‹ï¼š**

     ```tsx
     import { PageContainer } from '@ant-design/pro-components';
     import { Badge, Card, Descriptions, message } from 'antd';
     import React, { useEffect, useState } from 'react';
     import { useParams } from 'react-router';
     import moment from "moment";
     import {getInterfaceInfoByIdUsingGet} from "@/services/linksauce-backend/interfaceInfoController";
     
     const InterfaceInfo: React.FC = () => {
       const [loading, setLoading] = useState(false);
       const [data, setData] = useState<API.InterfaceInfo>();
     
       const params = useParams();
     
       const loadData = async () => {
         if (!params.id) {
           message.error('æ— æ•°æ®ï¼Œè¯·é‡è¯•');
         }
         setLoading(true);
         try {
           const res = await getInterfaceInfoByIdUsingGet({
             id: Number(params.id),
           });
           setData(res?.data);
           setLoading(false);
         } catch (error: any) {
           setLoading(false);
           message.error('è¯·æ±‚å¤±è´¥,' + error.message);
         }
       };
     
       useEffect(() => {
         loadData();
       }, []);
     
       return (
         <PageContainer title={'æ¥å£è¯¦æƒ…'}>
           <Card loading={loading}>
             {data ? (
               <Descriptions title={data.name} column={2} layout="vertical" bordered={true}>
                 <Descriptions.Item label="æè¿°">{data.description}</Descriptions.Item>
                 <Descriptions.Item label="æ¥å£çŠ¶æ€">
                   {data.status === 0 ? (
                     <Badge text={'å…³é—­'} status={'default'} />
                   ) : (
                     <Badge text={'å¯ç”¨'} status={'processing'} />
                   )}
                 </Descriptions.Item>
                 <Descriptions.Item label="è¯·æ±‚åœ°å€">{data.url}</Descriptions.Item>
                 <Descriptions.Item label="è¯·æ±‚æ–¹æ³•">{data.method}</Descriptions.Item>
                 <Descriptions.Item label="è¯·æ±‚å¤´">{data.requestHeader}</Descriptions.Item>
                 <Descriptions.Item label="å“åº”å¤´">{data.responseHeader}</Descriptions.Item>
                 <Descriptions.Item label="åˆ›å»ºæ—¶é—´">{moment(data.createTime).format('yyyy-MM-DD HH:mm:ss')}</Descriptions.Item>
                 <Descriptions.Item label="æ›´æ–°æ—¶é—´">{moment(data.updateTime).format('yyyy-MM-DD HH:mm:ss')}</Descriptions.Item>
               </Descriptions>
             ) : (
               <>æ¥å£ä¸å­˜åœ¨</>
             )}
           </Card>
         </PageContainer>
       );
     };
     
     export default InterfaceInfo;
     ```

5.   **æ•ˆæœå¦‚ä¸‹**

     ç‚¹å‡»åè·³è½¬è¯¦æƒ…

     ![image-20240405163522953](å¼€å‘æ–‡æ¡£.assets/image-20240405163522953.png)



### 3ã€ç”³è¯·ç­¾å

---

**æ³¨å†Œç”¨æˆ·çš„æ—¶å€™å°±ç»™ä»–åˆ†é…ä¸€ä¸ªç­¾å**

å…ˆåœ¨**User**ç±»å’Œ`UserMapper.xml`ä¸­åŠ ä¸€ä¸‹**accessKey**ã€**secretKey**çš„å­—æ®µ

ä¿®æ”¹`User.java`,å¢åŠ å¦‚ä¸‹å­—æ®µ

```java
/**
 * ç­¾å accessKey
 */
private String accessKey;

/**
 * ç­¾å secretKey
 */
private String secretKey;
```

ä¿®æ”¹`UserMapper.xml`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ohh.project.mapper.UserMapper">

    <resultMap id="BaseResultMap" type="com.ohh.project.model.entity.User">
        <id property="id" column="id" jdbcType="BIGINT"/>
        <result property="userName" column="userName" jdbcType="VARCHAR"/>
        <result property="userAccount" column="userAccount" jdbcType="VARCHAR"/>
        <result property="userAvatar" column="userAvatar" jdbcType="VARCHAR"/>
        <result property="gender" column="gender" jdbcType="TINYINT"/>
        <result property="userRole" column="userRole" jdbcType="VARCHAR"/>
        <result property="userPassword" column="userPassword" jdbcType="VARCHAR"/>
        <result property="accessKey" column="accessKey" jdbcType="VARCHAR"/>
        <result property="secretKey" column="secretKey" jdbcType="VARCHAR"/>
        <result property="createTime" column="createTime" jdbcType="TIMESTAMP"/>
        <result property="updateTime" column="updateTime" jdbcType="TIMESTAMP"/>
        <result property="isDelete" column="isDelete" jdbcType="TINYINT"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,userName,userAccount,
        userAvatar,gender,userRole,
        userPassword,accessKey,secretKey,createTime,updateTime,
        isDelete
    </sql>
</mapper>
```

æ›´æ–°æ³¨å†Œæ–¹æ³•`UserServiceImpl.java`

```java
@Override
public long userRegister(String userAccount, String userPassword, String checkPassword) {
    // 1. æ ¡éªŒ
    if (StringUtils.isAnyBlank(userAccount, userPassword, checkPassword)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "å‚æ•°ä¸ºç©º");
    }
    if (userAccount.length() < 4) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·è´¦å·è¿‡çŸ­");
    }
    if (userPassword.length() < 8 || checkPassword.length() < 8) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ç”¨æˆ·å¯†ç è¿‡çŸ­");
    }
    // å¯†ç å’Œæ ¡éªŒå¯†ç ç›¸åŒ
    if (!userPassword.equals(checkPassword)) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR, "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´");
    }
    synchronized (userAccount.intern()) {
        // è´¦æˆ·ä¸èƒ½é‡å¤
        QueryWrapper<User> queryWrapper = new QueryWrapper<>();
        queryWrapper.eq("userAccount", userAccount);
        long count = userMapper.selectCount(queryWrapper);
        if (count > 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR, "è´¦å·é‡å¤");
        }
        // 2. åŠ å¯†
        String encryptPassword = DigestUtils.md5DigestAsHex((SALT + userPassword).getBytes());
        // 3. åˆ†é… accessKey, secretKey
        String accessKey = DigestUtil.md5Hex(SALT + userAccount + RandomUtil.randomNumbers(4));
        String secretKey = DigestUtil.md5Hex(SALT + userAccount + RandomUtil.randomNumbers(8));
        // 4. æ’å…¥æ•°æ®
        User user = new User();
        user.setUserAccount(userAccount);
        user.setUserPassword(encryptPassword);
        user.setAccessKey(accessKey);
        user.setSecretKey(secretKey);
        boolean saveResult = this.save(user);
        if (!saveResult) {
            throw new BusinessException(ErrorCode.SYSTEM_ERROR, "æ³¨å†Œå¤±è´¥ï¼Œæ•°æ®åº“é”™è¯¯");
        }
        return user.getId();
    }
}
```



**åŠŸèƒ½æµ‹è¯•ï¼š**å‰å¾€http://localhost:7529/api/doc.htmlè¿›è¡Œæ³¨å†Œã€‚		

åˆ†é…æˆåŠŸ~

![image-20240405164016260](å¼€å‘æ–‡æ¡£.assets/image-20240405164016260.png)



## å…«ã€åœ¨çº¿è°ƒç”¨

### 1ã€ä¿®æ”¹åç«¯

---

è¿™é‡Œæˆ‘ä»¬å…¶å®æœ‰ä¸¤ç§æ–¹æ¡ˆ

-   èµ°åç«¯è°ƒç”¨
-   ç›´æ¥è¯·æ±‚æ¨¡æ‹Ÿæ¥å£

![image-20230119102921966](å¼€å‘æ–‡æ¡£.assets/image-20230119102921966.png)



è¿™é‡Œç”¨ç¬¬ä¸€ç§æµæ–¹æ¡ˆï¼Œæ›´å®‰å…¨æ›´è§„èŒƒã€‚æ¨¡æ‹Ÿæ¥å£çš„åœ°å€å°±ä¸ç”¨æš´éœ²å‡ºæ¥

å¤§æ¦‚æµç¨‹å¦‚ä¸‹

1.  å‰ç«¯å°†ç”¨æˆ·è¾“å…¥çš„è¯·æ±‚å‚æ•°å’Œè¦æµ‹è¯•çš„æ¥å£ idå‘ç»™å¹³å°åç«¯

2.  è°ƒç”¨å‰æ ¡éªŒ

3.  å¹³å°åç«¯å»è°ƒç”¨æ¨¡æ‹Ÿæ¥å£



**æ–°å¢DTOç±»**

```java
package com.ohh.project.model.dto.interfaceinfo;

import lombok.Data;

import java.io.Serializable;

/**
 * æ¥å£è°ƒç”¨è¯·æ±‚
 *
 * @TableName product
 */
@Data
public class InterfaceInfoInvokeRequest implements Serializable {

    /**
     * ä¸»é”®
     */
    private Long id;

    /**
     * ç”¨æˆ·è¯·æ±‚å‚æ•°
     */
    private String userRequestParams;

    private static final long serialVersionUID = 1L;

}
```



**controller**ç±»æ–°å¢æ–¹æ³•`InterfaceInfoController.java`

```java
/**
 * åœ¨çº¿è°ƒç”¨æ¥å£
 *
 * @param interfaceInfoInvokeRequest æºå¸¦idã€è¯·æ±‚å‚æ•°
 * @return data
 */
@PostMapping("/invoke")
public BaseResponse<Object> invokeInterface(@RequestBody InterfaceInfoInvokeRequest interfaceInfoInvokeRequest, HttpServletRequest request) throws UnsupportedEncodingException {
    if (interfaceInfoInvokeRequest == null || interfaceInfoInvokeRequest.getId() < 0) {
        throw new BusinessException(ErrorCode.PARAMS_ERROR);
    }
    // åˆ¤æ–­æ¥å£æ˜¯å¦å­˜åœ¨
    long id = interfaceInfoInvokeRequest.getId();
    InterfaceInfo interfaceInfo = interfaceInfoService.getById(id);
    if (interfaceInfo == null) {
        throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);
    }
    if (interfaceInfo.getStatus() != InterfaceInfoStatusEnum.ONLINE.getValue()) {
        throw new BusinessException(ErrorCode.SYSTEM_ERROR, "æ¥å£æœªä¸Šçº¿");
    }
    // å¾—åˆ°å½“å‰ç”¨æˆ·
    User loginUser = userService.getLoginUser(request);
    String accessKey = loginUser.getAccessKey();
    String secretKey = loginUser.getSecretKey();
    linkSauceClient client = new linkSauceClient(accessKey, secretKey);
    // å…ˆå†™æ­»è¯·æ±‚
    String userRequestParams = interfaceInfoInvokeRequest.getUserRequestParams();
    com.linksauce.linksauceclientsdk.model.User user = JSONUtil.toBean(userRequestParams, com.linksauce.linksauceclientsdk.model.User.class);
    String result = client.getNameByPostWithJson(user);
    return ResultUtils.success(result);
}
```



### 2ã€ä¿®æ”¹å‰ç«¯

Ant Designä¸­ Formç»„ä»¶ onFinishï¼š æäº¤è¡¨å•ä¸”æ•°æ®éªŒè¯æˆåŠŸåå›è°ƒäº‹ä»¶

ç¼–å†™**onFinish**æ–¹æ³•

```tsx
  const onFinish = async (requestData: API.InvokeInterfaceRequest) => {
    if (!params.id) {
      message.error('æ— æ•°æ®ï¼Œè¯·é‡è¯•');
    }
    try {
      const res = await invokeInterfaceUsingPOST({
        id: Number(params.id),
        ...requestData,
      });
      setResData(res.data);
      message.success('è°ƒç”¨æˆåŠŸ!');
    } catch (error: any) {
      message.error('è¯·æ±‚å¤±è´¥,' + error.message);
    }
  };
```

å†ä¿®æ”¹ä¸€ä¸‹æ ·å¼

```tsx
import { PageContainer } from '@ant-design/pro-components';
import { Badge, Card, Descriptions, message, Form, Input, Button, Divider } from 'antd';
import React, { useEffect, useState } from 'react';
import {
  getInterfaceInfoByIdUsingGET,
  invokeInterfaceUsingPOST,
} from '@/services/api-platform-backend/interfaceInfoController';
import { useParams } from 'react-router';
import moment from 'moment';

const InterfaceInfo: React.FC = () => {
  const [loading, setLoading] = useState(false);
  const [data, setData] = useState<API.InterfaceInfo>();
  const [resData, setResData] = useState<any>();

  const params = useParams();

  const loadData = async () => {
    if (!params.id) {
      message.error('æ— æ•°æ®ï¼Œè¯·é‡è¯•');
    }
    setLoading(true);
    try {
      const res = await getInterfaceInfoByIdUsingGET({
        id: Number(params.id),
      });
      setData(res?.data);
      setLoading(false);
    } catch (error: any) {
      setLoading(false);
      message.error('è¯·æ±‚å¤±è´¥,' + error.message);
    }
  };

  useEffect(() => {
    loadData();
  }, []);

  const onFinish = async (requestData: API.InvokeInterfaceRequest) => {
    if (!params.id) {
      message.error('æ— æ•°æ®ï¼Œè¯·é‡è¯•');
    }
    try {
      const res = await invokeInterfaceUsingPOST({
        id: Number(params.id),
        ...requestData,
      });
      setResData(res.data);
      message.success('è°ƒç”¨æˆåŠŸ!');
    } catch (error: any) {
      message.error('è¯·æ±‚å¤±è´¥,' + error.message);
    }
  };

  return (
    <PageContainer title={'æ¥å£è¯¦æƒ…'}>
      {data ? (
        <>
          <Card loading={loading}>
            <Descriptions title={data.name} column={2} layout="vertical" bordered={true}>
              <Descriptions.Item label="æè¿°">{data.description}</Descriptions.Item>
              <Descriptions.Item label="æ¥å£çŠ¶æ€">
                {data.status === 0 ? (
                  <Badge text={'å…³é—­'} status={'default'} />
                ) : (
                  <Badge text={'å¯ç”¨'} status={'processing'} />
                )}
              </Descriptions.Item>
              <Descriptions.Item label="è¯·æ±‚åœ°å€">{data.url}</Descriptions.Item>
              <Descriptions.Item label="è¯·æ±‚æ–¹æ³•">{data.method}</Descriptions.Item>
              <Descriptions.Item label="è¯·æ±‚å¤´">{data.requestHeader}</Descriptions.Item>
              <Descriptions.Item label="è¯·æ±‚å‚æ•°">{data.requestParams}</Descriptions.Item>
              <Descriptions.Item label="å“åº”å¤´">{data.responseHeader}</Descriptions.Item>
              <Descriptions.Item label="åˆ›å»ºæ—¶é—´">
                {moment(data.createTime).format('yyyy-MM-DD HH:mm:ss')}
              </Descriptions.Item>
              <Descriptions.Item label="æ›´æ–°æ—¶é—´">
                {moment(data.updateTime).format('yyyy-MM-DD HH:mm:ss')}
              </Descriptions.Item>
            </Descriptions>
          </Card>
          <Divider />
          <Card title={'åœ¨çº¿è°ƒç”¨'}>
            <Form name="basic" layout={'vertical'} onFinish={onFinish}>
              <Form.Item label="è¯·æ±‚å‚æ•°" name="requestParams">
                <Input.TextArea />
              </Form.Item>
              <Form.Item>
                <Button type="primary" htmlType="submit">
                  è°ƒç”¨
                </Button>
              </Form.Item>
            </Form>
          </Card>
          {resData ? <Card title={'è°ƒç”¨ç»“æœ'}>{resData}</Card> : null}
        </>
      ) : (
        'æ¥å£ä¸å­˜åœ¨'
      )}
    </PageContainer>
  );
};

export default InterfaceInfo;

```

**æµ‹è¯•å¦‚ä¸‹ï¼š**

![image-20240405213744218](å¼€å‘æ–‡æ¡£.assets/image-20240405213744218.png)



## ä¹ã€æ¥å£è°ƒç”¨æ¬¡æ•°ç»Ÿè®¡

**éœ€æ±‚**

1. ç”¨æˆ·æ¯æ¬¡è°ƒç”¨æ¥å£æˆåŠŸï¼Œæ¬¡æ•°+1
2. ç»™ç”¨æˆ·åˆ†é…æˆ–è€…ç”¨æˆ·è‡ªä¸»ç”³è¯·è°ƒç”¨æ¬¡æ•°

**ä¸šåŠ¡æµç¨‹**

1. ç”¨æˆ·è°ƒç”¨æ¥å£ï¼ˆä¹‹å‰å·²å®Œæˆï¼‰
2. ä¿®æ”¹æ•°æ®åº“ï¼Œè°ƒç”¨æ¬¡æ•°+1



### 1ã€è®¾è®¡åº“è¡¨

å“ªä¸ªç”¨æˆ·ï¼Ÿå“ªä¸ªæ¥å£ï¼Ÿ
ç”¨æˆ·=>æ¥å£ï¼ˆå¤šå¯¹å¤šï¼‰

**ç”¨æˆ·è°ƒç”¨æ¥å£å…³ç³»è¡¨**

```sql
-- ç”¨æˆ·è°ƒç”¨æ¥å£å…³ç³»è¡¨
create table if not exists linksauce.`user_interface_info`
(
    `id` bigint not null auto_increment comment 'ä¸»é”®' primary key,
    `userId` bigint not null comment 'è°ƒç”¨ç”¨æˆ·Id',
    `interfaceInfoId` bigint not null comment 'æ¥å£Id',
    `totalNum` int default 0 not null comment 'æ€»è°ƒç”¨æ¬¡æ•°',
    `leftNum` int default 0 not null comment 'å‰©ä½™è°ƒç”¨æ¬¡æ•°',
    `status` int default 0 not null comment '0-æ­£å¸¸ ï¼Œ1-ç¦ç”¨',
    `createTime` datetime default CURRENT_TIMESTAMP not null comment 'åˆ›å»ºæ—¶é—´',
    `updateTime` datetime default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP comment 'æ›´æ–°æ—¶é—´',
    `isDelete` tinyint default 0 not null comment 'æ˜¯å¦åˆ é™¤(0-æœªåˆ , 1-å·²åˆ )'
) comment 'ç”¨æˆ·è°ƒç”¨æ¥å£å…³ç³»è¡¨';
```

æ‰§è¡Œsqlè¯­å¥



**ä½¿ç”¨MybatisXæ’ä»¶**

ç”Ÿæˆuser_interface_infoè¡¨çš„ä»£ç 

åœ¨isDeleteä¸Š<font color='red'>å¢åŠ @TableLogic</font>æ³¨é‡Š ä»£è¡¨é€»è¾‘åˆ é™¤

```java
/**
 * ç”¨æˆ·è°ƒç”¨æ¥å£å…³ç³»è¡¨
 * @TableName user_interface_info
 */
@TableName(value ="user_interface_info")
@Data
public class UserInterfaceInfo implements Serializable {
    /**
     * ä¸»é”®
     */
    @TableId(type = IdType.AUTO)
    private Long id;

		// ...

    /**
     * æ˜¯å¦åˆ é™¤(0-æœªåˆ , 1-å·²åˆ )
     */
    @TableLogic
    private Integer isDelete;

    @TableField(exist = false)
    private static final long serialVersionUID = 1L;
}
```



### 2ã€åŸºç¡€å¢åˆ æ”¹æŸ¥

åœ¨dtoä¸­åˆ›å»ºç±»

![image-20240406155318861](å¼€å‘æ–‡æ¡£.assets/image-20240406155318861.png)



å†å¤åˆ¶ä¹‹å‰çš„**controller**æ”¹åæ›¿æ¢

```java
package com.ohh.project.controller;

// import ...
import com.ohh.project.model.entity.User;
import com.ohh.project.model.entity.UserInterfaceInfo;
import com.ohh.project.service.UserInterfaceInfoService;
import com.ohh.project.service.UserService;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.BeanUtils;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;
import java.util.List;

/**
 * æ¥å£ç®¡ç†
 *
 * @author ohh
 */
@RestController
@RequestMapping("/userInterfaceInfo")
@Slf4j
public class UserInterfaceInfoController {

    @Resource
    private UserInterfaceInfoService userInterfaceInfoService;

    @Resource
    private UserService userService;

    /**
     * åˆ›å»º
     *
     * @param userInterfaceInfoAddRequest
     * @param request
     * @return
     */
    @PostMapping("/add")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Long> addUserInterfaceInfo(@RequestBody UserInterfaceInfoAddRequest userInterfaceInfoAddRequest, HttpServletRequest request) {
        if (userInterfaceInfoAddRequest == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        UserInterfaceInfo userInterfaceInfo = new UserInterfaceInfo();
        BeanUtils.copyProperties(userInterfaceInfoAddRequest, userInterfaceInfo);
        // æ ¡éªŒ
        userInterfaceInfoService.validUserInterfaceInfo(userInterfaceInfo, true);
        User loginUser = userService.getLoginUser(request);
        userInterfaceInfo.setUserId(loginUser.getId());
        boolean result = userInterfaceInfoService.save(userInterfaceInfo);
        if (!result) {
            throw new BusinessException(ErrorCode.OPERATION_ERROR);
        }
        long newUserInterfaceInfoId = userInterfaceInfo.getId();
        return ResultUtils.success(newUserInterfaceInfoId);
    }

    /**
     * åˆ é™¤
     *
     * @param deleteRequest
     * @param request
     * @return
     */
    @PostMapping("/delete")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Boolean> deleteUserInterfaceInfo(@RequestBody DeleteRequest deleteRequest, HttpServletRequest request) {
        if (deleteRequest == null || deleteRequest.getId() <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        User user = userService.getLoginUser(request);
        long id = deleteRequest.getId();
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        UserInterfaceInfo oldUserInterfaceInfo = userInterfaceInfoService.getById(id);
        if (oldUserInterfaceInfo == null) {
            throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);
        }
        // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯åˆ é™¤
        if (!oldUserInterfaceInfo.getUserId().equals(user.getId()) && !userService.isAdmin(request)) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
        }
        boolean b = userInterfaceInfoService.removeById(id);
        return ResultUtils.success(b);
    }

    /**
     * æ›´æ–°
     *
     * @param userInterfaceInfoUpdateRequest
     * @param request
     * @return
     */
    @PostMapping("/update")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Boolean> updateUserInterfaceInfo(@RequestBody UserInterfaceInfoUpdateRequest userInterfaceInfoUpdateRequest, HttpServletRequest request) {
        if (userInterfaceInfoUpdateRequest == null || userInterfaceInfoUpdateRequest.getId() <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        UserInterfaceInfo userInterfaceInfo = new UserInterfaceInfo();
        BeanUtils.copyProperties(userInterfaceInfoUpdateRequest, userInterfaceInfo);
        // å‚æ•°æ ¡éªŒ
        userInterfaceInfoService.validUserInterfaceInfo(userInterfaceInfo, false);
        User user = userService.getLoginUser(request);
        long id = userInterfaceInfoUpdateRequest.getId();
        // åˆ¤æ–­æ˜¯å¦å­˜åœ¨
        UserInterfaceInfo oldUserInterfaceInfo = userInterfaceInfoService.getById(id);
        if (oldUserInterfaceInfo == null) {
            throw new BusinessException(ErrorCode.NOT_FOUND_ERROR);
        }
        // ä»…æœ¬äººæˆ–ç®¡ç†å‘˜å¯ä¿®æ”¹
        if (!oldUserInterfaceInfo.getUserId().equals(user.getId()) && !userService.isAdmin(request)) {
            throw new BusinessException(ErrorCode.NO_AUTH_ERROR);
        }
        boolean result = userInterfaceInfoService.updateById(userInterfaceInfo);
        return ResultUtils.success(result);
    }

    /**
     * æ ¹æ® id è·å–
     *
     * @param id
     * @return
     */
    @GetMapping("/get")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<UserInterfaceInfo> getUserInterfaceInfoById(long id) {
        if (id <= 0) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        UserInterfaceInfo userInterfaceInfo = userInterfaceInfoService.getById(id);
        return ResultUtils.success(userInterfaceInfo);
    }

    /**
     * è·å–åˆ—è¡¨ï¼ˆä»…ç®¡ç†å‘˜å¯ä½¿ç”¨ï¼‰
     *
     * @param userInterfaceInfoQueryRequest
     * @return
     */
    @GetMapping("/list")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<List<UserInterfaceInfo>> listUserInterfaceInfo(UserInterfaceInfoQueryRequest userInterfaceInfoQueryRequest) {
        UserInterfaceInfo userInterfaceInfoQuery = new UserInterfaceInfo();
        if (userInterfaceInfoQueryRequest != null) {
            BeanUtils.copyProperties(userInterfaceInfoQueryRequest, userInterfaceInfoQuery);
        }
        QueryWrapper<UserInterfaceInfo> queryWrapper = new QueryWrapper<>(userInterfaceInfoQuery);
        List<UserInterfaceInfo> userInterfaceInfoList = userInterfaceInfoService.list(queryWrapper);
        return ResultUtils.success(userInterfaceInfoList);
    }

    /**
     * åˆ†é¡µè·å–åˆ—è¡¨
     *
     * @param userInterfaceInfoQueryRequest
     * @param request
     * @return
     */
    @GetMapping("/list/page")
    @AuthCheck(mustRole = UserConstant.ADMIN_ROLE)
    public BaseResponse<Page<UserInterfaceInfo>> listUserInterfaceInfoByPage(UserInterfaceInfoQueryRequest userInterfaceInfoQueryRequest, HttpServletRequest request) {
        if (userInterfaceInfoQueryRequest == null) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        UserInterfaceInfo userInterfaceInfoQuery = new UserInterfaceInfo();
        BeanUtils.copyProperties(userInterfaceInfoQueryRequest, userInterfaceInfoQuery);
        long current = userInterfaceInfoQueryRequest.getCurrent();
        long size = userInterfaceInfoQueryRequest.getPageSize();
        String sortField = userInterfaceInfoQueryRequest.getSortField();
        String sortOrder = userInterfaceInfoQueryRequest.getSortOrder();
        // é™åˆ¶çˆ¬è™«
        if (size > 50) {
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        QueryWrapper<UserInterfaceInfo> queryWrapper = new QueryWrapper<>(userInterfaceInfoQuery);
        queryWrapper.orderBy(StringUtils.isNotBlank(sortField),
                sortOrder.equals(CommonConstant.SORT_ORDER_ASC), sortField);
        Page<UserInterfaceInfo> userInterfaceInfoPage = userInterfaceInfoService.page(new Page<>(current, size), queryWrapper);
        return ResultUtils.success(userInterfaceInfoPage);
    }

}
```



### 3ã€è°ƒç”¨æ¬¡æ•°ç»Ÿè®¡

ç”¨æˆ·æ¯æ¬¡è°ƒç”¨æ¥å£æˆåŠŸï¼Œæ¬¡æ•°+1ï¼ˆservice)

**ç¼–å†™æ–¹æ³•**

åœ¨**service**å±‚çš„**`UserInterfaceInfoService`**ç¼–å†™æ–¹æ³•

```java
    @Override
    public boolean invokeCount(long interfaceInfoId, long userId) {
        // åˆ¤æ–­
        if (interfaceInfoId <= 0 || userId <= 0){
            throw new BusinessException(ErrorCode.PARAMS_ERROR);
        }
        UpdateWrapper<UserInterfaceInfo> updateWrapper = new UpdateWrapper<>();
        updateWrapper.eq("interfaceInfoId",interfaceInfoId);
        updateWrapper.eq("userId",userId);
        // updateWrapper.gt("leftNum",0);
        updateWrapper.setSql("leftNum = leftNum - 1,totalNum = totalNum + 1");
        return this.update(updateWrapper);
        
    }
```

<font color='red' >æ³¨æ„ï¼šå…¶å®è¿™é‡Œåº”è¯¥æ·»åŠ äº‹åŠ¡ï¼Œæ·»åŠ é”</font>

æ¥å£æµ‹è¯•æˆåŠŸ



## åã€ç½‘å…³

ä»€ä¹ˆæ˜¯ç½‘å…³ï¼Ÿç†è§£æˆç«è½¦ç«™çš„æ£€ç¥¨å£ï¼Œ**ç»Ÿä¸€** æ£€ç¥¨

**ç½‘å…³ä¼˜ç‚¹**ï¼š ç»Ÿä¸€è¿›è¡Œæ“ä½œï¼Œå»å¤„ç†ä¸€äº›é—®é¢˜



### 1ã€ç½‘å…³ä½œç”¨

1. è·¯ç”±
2. è´Ÿè½½å‡è¡¡
3. ç»Ÿä¸€é‰´æƒ
4. ç»Ÿä¸€å¤„ç†è·¨åŸŸ
5. ç»Ÿä¸€ä¸šåŠ¡å¤„ç†ï¼ˆç¼“å­˜ï¼‰
6. è®¿é—®æ§åˆ¶
7. å‘å¸ƒæ§åˆ¶
8. æµé‡æŸ“è‰²
9. ç»Ÿä¸€æ¥å£ä¿æŠ¤
   1. é™åˆ¶è¯·æ±‚
   2. ä¿¡æ¯è„±æ•
   3. é™çº§ï¼ˆç†”æ–­ï¼‰
   4. é™æµ å­¦ä¹ ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå­¦ä¹ éœ²æ¡¶ç®—æ³•ï¼Œå­¦ä¹ ä¸€ä¸‹RedislimitHandler
   5. è¶…æ—¶æ—¶é—´
   6. é‡è¯•ï¼ˆä¸šåŠ¡ä¿æŠ¤ï¼‰
10. ç»Ÿä¸€æ—¥å¿—
11. ç»Ÿä¸€æ–‡æ¡£



### 2ã€å…·ä½“ä½œç”¨

**è·¯ç”±**

èµ·åˆ°è½¬å‘çš„ä½œç”¨ï¼Œæ¯”å¦‚æœ‰æ¥å£Aå’Œæ¥å£B,ç½‘å…³ä¼šè®°å½•è¿™äº›ä¿¡æ¯ï¼Œæ ¹æ®ç”¨æˆ·è®¿é—®çš„åœ°å€å’Œå‚æ•°ï¼Œè½¬å‘è¯·æ±‚åˆ°å¯¹åº”çš„æ¥å£ï¼ˆæœåŠ¡å™¨/é›†ç¾¤ï¼‰

ç”¨æˆ·aè°ƒç”¨æ¥å£A

/a => æ¥å£A
/b => æ¥å£B

https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories



**è´Ÿè½½å‡è¡¡**

åœ¨è·¯ç”±çš„åŸºç¡€ä¸Šå¯ä»¥è½¬å‘åˆ°æŸä¸€ä¸ªæœåŠ¡å™¨

/c => æœåŠ¡A/ é›†ç¾¤Aï¼ˆéšæœºè½¬å‘åˆ°å…¶ä¸­çš„æŸä¸€ä¸ªæœºå™¨ï¼‰

uriä»å›ºå®šåœ°å€æ”¹æˆb:xx



**ç»Ÿä¸€é‰´æƒ**

åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è¿›è¡Œæ“ä½œï¼Œæ— è®ºè®¿é—®ä»€ä¹ˆæ¥å£ï¼Œæˆ‘éƒ½ç»Ÿä¸€å»åˆ¤æ–­æƒé™ï¼Œä¸ç”¨é‡å¤å†™



**ç»Ÿä¸€å¤„ç†è·¨åŸŸ**

ç½‘å…³ç»Ÿä¸€å¤„ç†è·¨åŸŸï¼Œä¸ç”¨åœ¨æ¯ä¸ªé¡¹ç›®å•ç‹¬å¤„ç†

https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#cors-configuration



**ç»Ÿä¸€ä¸šåŠ¡å¤„ç†**

æŠŠæ¯ä¸ªé¡¹ç›®ä¸­éƒ½è¦åšçš„é€šç”¨é€»è¾‘æ”¾åˆ°ä¸Šå±‚ï¼ˆç½‘å…³ï¼‰ï¼Œç»Ÿä¸€å¤„ç†ï¼Œæ¯”å¦‚æœ¬é¡¹ç›®çš„æ¬¡æ•°ç»Ÿè®¡



**è®¿é—®æ§åˆ¶**

é»‘ç™½åå•ï¼Œæ¯”å¦‚é™åˆ¶DDOS IP



**å‘å¸ƒæ§åˆ¶**

ç°åº¦å‘å¸ƒï¼Œæ¯”å¦‚ä¸Šçº¿æ–°æ¥å£ï¼Œå…ˆç»™æ–°æ¥å£åˆ†é… 20%æµé‡ï¼Œè€æ¥å£80% ,å†æ…¢æ…¢è°ƒæ•´æ¯”ä¾‹

https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-weight-route-predicate-factory



**æµé‡æŸ“è‰²**

åŒºåˆ†ç”¨æˆ·æ¥æº

ç»™è¯·æ±‚ï¼ˆæµé‡ï¼‰æ·»åŠ ä¸€äº›æ ‡è¯†ï¼Œä¸€èˆ¬æ˜¯è®¾ç½®è¯·æ±‚å¤´ä¸­ï¼Œæ·»åŠ æ–°çš„è¯·æ±‚å¤´
https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-addrequestheader-gatewayfilter-factory

**å…¨å±€æŸ“è‰²**ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#default-filters



**æ¥å£ä¿æŠ¤**

1. é™åˆ¶è¯·æ±‚

   https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#requestheadersiz-gatewayfilter-factory

2. ä¿¡æ¯è„±æ• 

   https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-removerequestheader-gatewayfilter-factory

3. é™çº§ï¼ˆç†”æ–­ï¼‰ è¿›è¡Œå…œåº•

   https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#fallback-headers

4. é™æµ   

   https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-requestratelimiter-gatewayfilter-factory

5. è¶…æ—¶æ—¶é—´    è¶…æ—¶å°±ä¸­æ–­

   https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#http-timeouts-configuration 

6. é‡è¯•ï¼ˆä¸šåŠ¡ä¿æŠ¤ï¼‰ï¼š

   https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#the-retry-gatewayfilter-factory

   

**ç»Ÿä¸€æ—¥å¿—**

ç»Ÿä¸€çš„è¯·æ±‚ï¼Œå“åº”ä¿¡æ¯è®°å½•



**ç»Ÿä¸€æ–‡æ¡£**

å°†ä¸‹æ¸¸é¡¹ç›®çš„æ–‡æ¡£è¿›è¡Œèšåˆï¼Œåœ¨ä¸€ä¸ªé¡µé¢ç»Ÿä¸€æŸ¥çœ‹

å»ºè®®ç”¨ï¼šhttps://doc.xiaominfo.com/docs/middleware-sources/aggregation-introduction



**ç½‘å…³çš„åˆ†ç±»**

-   **å…¨å±€ç½‘å…³ï¼ˆæ¥å…¥å±‚ç½‘å…³ï¼‰**ä½œç”¨æ˜¯è´Ÿè½½å‡è¡¡ã€è¯·æ±‚æ—¥å¿—ç­‰ï¼Œä¸å’Œä¸šåŠ¡é€»è¾‘ç»‘å®š
-   **ä¸šåŠ¡ç½‘å…³ï¼ˆå¾®æœåŠ¡ç½‘å…³ï¼‰**ä¼šæœ‰ä¸€äº›ä¸šåŠ¡é€»è¾‘ï¼Œä½œç”¨æ˜¯å°†è¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„ä¸šåŠ¡/é¡¹ç›®/æ¥å£/æœåŠ¡

å‚è€ƒæ–‡ç« ï¼šhttps://blog.csdn.net/qq_21040559/article/details/122961395



**å®ç°**

1. **Nginx** ï¼ˆå…¨å±€ç½‘å…³ï¼‰ï¼Œ**Kongç½‘å…³**ï¼ˆAPIç½‘å…³ï¼‰ï¼Œ  **ç¼–ç¨‹æˆæœ¬ç›¸å¯¹è¾ƒé«˜**
2. **Spring Cloud Gateway**ï¼ˆå–ä»£äº†Zuulï¼‰æ€§èƒ½é«˜ å¯ä»¥ç”¨javaä»£ç æ¥å†™é€»è¾‘  é€‚äºå­¦ä¹ 

ç½‘å…³æŠ€æœ¯é€‰å‹ï¼šhttps://zhuanlan.zhihu.com/p/500587132





## åä¸€ã€Spring Cloud Gateway

å…¨éƒ¨å†…å®¹åŸºæœ¬æ¥è‡ªå®˜ç½‘

å®˜ç½‘ï¼šhttps://spring.io/projects/spring-cloud-gateway

å®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/current/reference//html/



**æ–°å»ºé¡¹ç›®**

åœ¨IDEAä¸­æ–°å»ºé¡¹ç›® å‹¾é€‰Gatewayã€Lombok

å‚è€ƒå®˜ç½‘get startedä¸­çš„å®ä¾‹ä»£ç 

```java
@SpringBootApplication
public class DemogatewayApplication {
	@Bean
	public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
		return builder.routes()
			.route("path_route", r -> r.path("/get")
				.uri("http://httpbin.org"))
			.route("host_route", r -> r.host("*.myhost.org")
				.uri("http://httpbin.org"))
			.route("rewrite_route", r -> r.host("*.rewrite.org")
				.filters(f -> f.rewritePath("/foo/(?<segment>.*)", "/${segment}"))
				.uri("http://httpbin.org"))
			.route("hystrix_route", r -> r.host("*.hystrix.org")
				.filters(f -> f.hystrix(c -> c.setName("slowcmd")))
				.uri("http://httpbin.org"))
			.route("hystrix_fallback_route", r -> r.host("*.hystrixfallback.org")
				.filters(f -> f.hystrix(c -> c.setName("slowcmd").setFallbackUri("forward:/hystrixfallback")))
				.uri("http://httpbin.org"))
			.route("limit_route", r -> r
				.host("*.limited.org").and().path("/anything/**")
				.filters(f -> f.requestRateLimiter(c -> c.setRateLimiter(redisRateLimiter())))
				.uri("http://httpbin.org"))
			.build();
	}
}
```

ç¼–å†™ä»£ç ï¼š

```java
package com.ohh;

// import ...

@SpringBootApplication
public class XuanapiGatewayApplication {

	public static void main(String[] args) {
		SpringApplication.run(XuanapiGatewayApplication.class, args);
	}

	@Bean
	public RouteLocator customRouteLocator(RouteLocatorBuilder builder) {
		return builder.routes()
				.route("to_baidu", r -> r.path("/baidu")
						.uri("http://www.baidu.com/"))
				.build();
	}
}

```

æµ‹è¯•ç™¾åº¦æˆåŠŸ



### 1ã€æ ¸å¿ƒæ¦‚å¿µ

#### 1.1. [Glossary](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#glossary)

å®˜æ–¹æ–‡æ¡£å¦‚ä¸‹

-   **Route**: The basic building block of the gateway. It is defined by an ID, a destination URI, a collection of predicates, and a collection of filters. A route is matched if the aggregate predicate is true.
-   **Predicate**: This is a [Java 8 Function Predicate](https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html). The input type is a [Spring Framework `ServerWebExchange`](https://docs.spring.io/spring/docs/5.0.x/javadoc-api/org/springframework/web/server/ServerWebExchange.html). This lets you match on anything from the HTTP request, such as headers or parameters.
-   **Filter**: These are instances of [`GatewayFilter`](https://github.com/spring-cloud/spring-cloud-gateway/tree/main/spring-cloud-gateway-server/src/main/java/org/springframework/cloud/gateway/filter/GatewayFilter.java) that have been constructed with a specific factory. Here, you can modify requests and responses before or after sending the downstream request.



1. è·¯ç”±ï¼ˆæ ¹æ®ä»€ä¹ˆæ¡ä»¶ï¼Œè½¬å‘åˆ°å“ªé‡Œï¼‰

2. æ–­è¨€ï¼ˆä¸€ç»„è§„åˆ™ï¼Œæ¡ä»¶ï¼Œç”¨æ¥ç¡®å®šå¦‚ä½•è½¬å‘è·¯ç”±ï¼‰

3. è¿‡æ»¤å™¨ï¼šå¯¹è¯·æ±‚è¿›è¡Œä¸€ç³»åˆ—çš„å¤„ç†ï¼Œæ¯”å¦‚æ·»åŠ è¯·æ±‚å¤´ï¼Œæ·»åŠ è¯·æ±‚å‚æ•°






#### 1.2. è¯·æ±‚æµç¨‹

1.  å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚
2.  Handler Mapping ï¼šæ ¹æ®æ–­è¨€ï¼Œå»å°†è¯·æ±‚è½¬å‘åˆ°å¯¹åº”çš„è·¯ç”±
3.  Web Handlerï¼šå¤„ç†è¯·æ±‚ï¼ˆä¸€å±‚å±‚ç»è¿‡è¿‡æ»¤å™¨ï¼‰
4.  å®é™…è°ƒç”¨æœåŠ¡

![image-20230131144724778](å¼€å‘æ–‡æ¡£.assets/image-20230131144724778.png)



### 2ã€ä¸¤ç§é…ç½®æ–¹å¼

1. é…ç½®å¼ ï¼ˆæ–¹ä¾¿ï¼Œè§„èŒƒï¼‰èƒ½ç”¨å°±ç”¨

   1. ç®€åŒ–ç‰ˆ

      ```yaml
      spring:
        cloud:
          gateway:
            routes:
            - id: after_route
              uri: https://example.org
              predicates:
              - Cookie=mycookie,mycookievalue
      ```

      

   2. å…¨ç§°

      ```yaml
      spring:
        cloud:
          gateway:
            routes:
            - id: after_route
              uri: https://example.org
              predicates:
              - name: Cookie
                args:
                  name: mycookie
                  regexp: mycookievalue
      ```

      

2. ç¼–ç¨‹å¼ ï¼ˆçµæ´»ï¼Œç›¸å¯¹éº»çƒ¦ï¼‰



### 3ã€è·¯ç”±çš„å„ç§æ–­è¨€

å®˜ç½‘åœ°å€:https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories

**ç›®å½•**

1. After  	  åœ¨xxæ—¶é—´ä¹‹å
2. Before     åœ¨xxæ—¶é—´ä¹‹å‰
3. Between åœ¨xxæ—¶é—´ä¹‹é—´
4. è¯·æ±‚ç±»åˆ«
5. è¯·æ±‚å¤´ï¼ˆåŒ…å«Cookie)
6. æŸ¥æ¶§å‚æ•°
7. å®¢æˆ·ç«¯åœ°å€
8. **æƒé‡**



**The After Route Predicate Factory**

å½“å‰æ—¶é—´åœ¨è¿™ä¸ªæ—¶é—´**ä¹‹å**ï¼Œå°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: after_route
        uri: https://example.org
        predicates:
        - After=2017-01-20T17:42:47.789-07:00[America/Denver]
```





**The Before Route Predicate Factory**

å½“å‰æ—¶é—´åœ¨è¿™ä¸ªæ—¶é—´**ä¹‹å‰**ï¼Œå°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: before_route
        uri: https://example.org
        predicates:
        - Before=2017-01-20T17:42:47.789-07:00[America/Denver]
```





**The Between Route Predicate Factory**

å½“å‰æ—¶é—´åœ¨è¿™ä¸ªæ—¶é—´**ä¹‹é—´**ï¼Œå°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: between_route
        uri: https://example.org
        predicates:
        - Between=2017-01-20T17:42:47.789-07:00[America/Denver], 2017-01-21T17:42:47.789-07:00[America/Denver]
```





**The Cookie Route Predicate Factory**

å¦‚æœä½ çš„**è¯·æ±‚å¤´cookie**çš„æ˜¯**chocolate**ï¼Œå®ƒçš„å€¼æ˜¯**ch.p**ï¼Œå°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: cookie_route
        uri: https://example.org
        predicates:
        - Cookie=chocolate, ch.p
```





**The Header Route Predicate Factory**

å¦‚æœä½ çš„**è¯·æ±‚å¤´**åŒ…å«**X-Request-Id**è¿™æ ·ä¸€ä¸ªè¯·æ±‚å¤´ï¼Œå¹¶ä¸”ï¼Œå®ƒçš„å€¼ç¬¦åˆ**æ­£åˆ™è¡¨è¾¾å¼çš„è§„åˆ™**ï¼Œå°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: header_route
        uri: https://example.org
        predicates:
        - Header=X-Request-Id, \d+
```





**The Host Route Predicate Factory**

å¦‚æœä½ çš„**è®¿é—®**çš„æ˜¯è¿™ä¸ª**.somehost.org,**.**anotherhost.org**ï¼Œ**åŸŸå**ï¼Œå°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: host_route
        uri: https://example.org
        predicates:
        - Host=**.somehost.org,**.anotherhost.org
```





**The Method Route Predicate Factory**

å¦‚æœä½ çš„**è¯·æ±‚ç±»åˆ«**æ˜¯è¿™ä¸ª**GET**ã€**POST**ï¼Œå°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: method_route
        uri: https://example.org
        predicates:
        - Method=GET,POST

```





**The Path Route Predicate Factory**

å¦‚æœä½ çš„**è®¿é—®çš„åœ°å€**æ˜¯ä»¥è¿™äº›**/red/{segment},/blue/{segment}**è·¯å¾„ä½œä¸ºå‰ç¼€ï¼Œå°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: path_route
        uri: https://example.org
        predicates:
        - Path=/red/{segment},/blue/{segment}
```





**The Query Route Predicate Factory**

æ ¹æ®**æŸ¥è¯¢æ¡ä»¶**ï¼Œæ¯”å¦‚red greet greenï¼Œå°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: query_route
        uri: https://example.org
        predicates:
        - Query=red, gree.
```





**The RemoteAddr Route Predicate Factory**

æ ¹æ®**è¿œç¨‹åœ°å€**ï¼Œæ¯”å¦‚ä½ çš„ç”¨æˆ·çš„ipåœ°å€æ˜¯192.168.1.1/24ï¼Œå°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: remoteaddr_route
        uri: https://example.org
        predicates:
        - RemoteAddr=192.168.1.1/24
```





**The Weight Route Predicate Factory**

æ ¹æ®ä½ è®¾ç½®çš„**æƒé‡**ï¼Œç»™ä½ æŠŠåŒä¸€ä¸ªè®¿é—®çš„åœ°å€ï¼Œé‡å®šåˆ°ä¸åŒçš„æœåŠ¡ï¼Œè½»æ¾å®ç°å‘å¸ƒæ§åˆ¶

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: weight_high
        uri: https://weighthigh.org
        predicates:
        - Weight=group1, 8
      - id: weight_low
        uri: https://weightlow.org
        predicates:
        - Weight=group1, 2
```





**The XForwarded Remote Addr Route Predicate Factory**

ä»è¯·æ±‚å¤´ä¸­å¦‚æœæ‹¿åˆ°XForwardedè¿™ä¸ª**è¯·æ±‚å¤´çš„åœ°å€**192.168.1.1/24 å°±ä¼šè®¿é—®å½“å‰è¿™ä¸ªè·¯ç”±

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: xforwarded_remoteaddr_route
        uri: https://example.org
        predicates:
        - XForwardedRemoteAddr=192.168.1.1/24
```







### 4ã€è¿‡æ»¤å™¨

**å®˜ç½‘æ–‡æ¡£**ï¼šhttps://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories

**åŸºæœ¬åŠŸèƒ½**ï¼šå¯¹è¯·æ±‚å¤´ã€è¯·æ±‚å‚æ•°ã€å“åº”å¤´çš„å¢åˆ æ”¹æŸ¥
		1.æ·»åŠ æ¸…æ±‚å¤´
		2.æ·»åŠ è¯·æ±‚å‚æ•°
		3.æ·»åŠ å“åº”å¤´	
		4.é™çº§
		5.é™æµ
		6.é‡è¯•



**The `AddRequestHeader` `GatewayFilter` Factory**

å¢åŠ è¯·æ±‚å¤´ ï¼ˆå¯ä»¥ç”¨ä½œæµé‡æŸ“è‰²ï¼‰

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: add_request_header_route
        uri: https://example.org
        filters:
        - AddRequestHeader=X-Request-red, blue
```



ä½¿ç”¨xuan-apiåšæµ‹è¯•

```yaml
server:
  port: 8090

spring:
  cloud:
    gateway:
      routes:
        - id: name_api_route
          uri: http://localhost:8123
          predicates:
            - Path=/api/**
          filters:
            - AddRequestHeader=color, blue
            - AddRequestParameter=name, mars
```

åœ¨åœ°å€æ è®¿é—®ï¼šhttp://localhost:8090/api/name/xuan

å¾—åˆ°ç»“æœå¦‚ä¸‹

![image-20230131162105385](å¼€å‘æ–‡æ¡£.assets/image-20230131162105385.png)





**The `AddRequestParameter` `GatewayFilter` Factory**

å¢åŠ è¯·æ±‚å‚æ•°

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: add_request_parameter_route
        uri: https://example.org
        filters:
        - AddRequestParameter=red, blue
```







**The `AddResponseHeader` `GatewayFilter` Factory**

æ·»åŠ å“åº”å¤´

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: add_response_header_route
        uri: https://example.org
        filters:
        - AddResponseHeader=X-Response-Red, Blue
```





**The `DedupeResponseHeader` `GatewayFilter` Factory**

å¦‚æœå“åº”å¤´ä¸­æœ‰é‡å¤çš„ï¼Œå»é‡

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: dedupe_response_header_route
        uri: https://example.org
        filters:
        - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
```



ä¿ç•™ç­–ç•¥ï¼Œç¬¬ä¸€ï¼Œæœ€åï¼Œéšæœº

The `DedupeResponseHeader` filter also accepts an optional `strategy` parameter. The accepted values are `RETAIN_FIRST` (default), `RETAIN_LAST`, and `RETAIN_UNIQUE`.





**Spring Cloud CircuitBreaker GatewayFilter Factory**

é™çº§

éœ€è¦å¼•å…¥**spring-cloud-starter-circuitbreaker-reactor-resilience4j**åŒ…

```xml
<dependency>
  <groupId>org.springframework.cloud</groupId>
  <artifactId>spring-cloud-starter-circuitbreaker-reactor-resilience4j</artifactId>
</dependency>
```

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: circuitbreaker_route
        uri: lb://backing-service:8088
        predicates:
        - Path=/consumingServiceEndpoint
        filters:
        - name: CircuitBreaker
          args:
            name: myCircuitBreaker
            fallbackUri: forward:/inCaseOfFailureUseThis
        - RewritePath=/consumingServiceEndpoint, /backingServiceEndpoint
```





**The `FallbackHeaders` `GatewayFilter` Factory**

é™çº§å¤„ç†å™¨ï¼Œå†™ä¸€ä¸‹é™çº§è§„åˆ™

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: ingredients
        uri: lb://ingredients
        predicates:
        - Path=//ingredients/**
        filters:
        - name: CircuitBreaker
          args:
            name: fetchIngredients
            fallbackUri: forward:/fallback
      - id: ingredients-fallback
        uri: http://localhost:9994
        predicates:
        - Path=/fallback
        filters:
        - name: FallbackHeaders
          args:
            executionExceptionTypeHeaderName: Test-Header
```





**The `MapRequestHeader` `GatewayFilter` Factory**

å¦‚æœä½ çš„**è¯·æ±‚å¤´**é‡Œé¢æœ‰**Blue**ï¼Œä¼šæŠŠ**Blue**çš„å€¼ç»™**X-Request-Red**ï¼Œç›¸å½“äºåšäº†æ˜ å°„

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: map_request_header_route
        uri: https://example.org
        filters:
        - MapRequestHeader=Blue, X-Request-Red
```





**The `PrefixPath` `GatewayFilter` Factory**

å‰ç¼€å¤„ç†å™¨

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: prefixpath_route
        uri: https://example.org
        filters:
        - PrefixPath=/mypath
```

è¿™ä¼šå°†/mypathä½œä¸ºæ‰€æœ‰åŒ¹é…è¯·æ±‚çš„è·¯å¾„çš„å‰ç¼€ã€‚å› æ­¤ï¼Œå¯¹/helloçš„è¯·æ±‚å°†å‘é€åˆ°/mypath/helloã€‚



**The `PreserveHostHeader` `GatewayFilter` Factoryatewayfilter-factory)**

è¯·æ±‚å¤´è½¬å‘çš„æ—¶å€™ï¼Œæœ‰æ—¶å€™**hostå€¼**ä¼šå˜ï¼Œè¿™ä¸ªå¯ä»¥ä¿è¯ä¸å˜

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: preserve_host_route
        uri: https://example.org
        filters:
        - PreserveHostHeader
```





**The `RequestRateLimiter` `GatewayFilter` Factory**

é™æµ

![image-20230131175738299](å¼€å‘æ–‡æ¡£.assets/image-20230131175738299.png)

ä¸€èˆ¬ä¼šä½¿ç”¨redis+ä»¤ç‰Œæ¡¶ç®—æ³•

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: requestratelimiter_route
        uri: https://example.org
        filters:
        - name: RequestRateLimiter
          args:
            redis-rate-limiter.replenishRate: 10
            redis-rate-limiter.burstCapacity: 20
            redis-rate-limiter.requestedTokens: 1
```







**`RequestHeaderSize` `GatewayFilter` Factory**

é™åˆ¶è¯·æ±‚å¤´å¤§å° **è¯·æ±‚ä¿æŠ¤**

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: requestheadersize_route
        uri: https://example.org
        filters:
        - RequestHeaderSize=1000B
```





**The RemoveRequestHeader Gateway Filter Factory**

ç§»é™¤è¯·æ±‚å¤´ ï¼ˆè„±æ•ï¼‰

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: removerequestheader_route
        uri: https://example.org
        filters:
        - RemoveRequestHeader=X-Request-Foo
```

This removes the `X-Request-Foo` header before it is sent downstream.





**The `RewritePath` `GatewayFilter` Factory**

æ”¹å†™ç‰¹æ®Šçš„è¯·æ±‚å‚æ•°

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: rewritepath_route
        uri: https://example.org
        predicates:
        - Path=/red/**
        filters:
        - RewritePath=/red/?(?<segment>.*), /$\{segment}
```







**The Retry `GatewayFilter` Factory**

è‡ªåŠ¨å¸®ä½ é‡è¯•æ¥å£ï¼Œé™çº§é‡è¯•

```yaml
spring:
  cloud:
    gateway:
      routes:
      - id: retry_test
        uri: http://localhost:8080/flakey
        predicates:
        - Host=*.retry.com
        filters:
        - name: Retry
          args:
            retries: 3
            statuses: BAD_GATEWAY
            methods: GET,POST
            backoff:
              firstBackoff: 10ms
              maxBackoff: 50ms
              factor: 2
              basedOnPreviousValue: false
```





**Default Filters**

é»˜è®¤è¿‡æ»¤å™¨ å¯ä»¥ç”¨ä½œå…¨å±€æŸ“è‰²

```yaml
spring:
  cloud:
    gateway:
      default-filters:
      - AddResponseHeader=X-Response-Default-Red, Default-Blue
      - PrefixPath=/httpbin
```





### 5ã€å…¶ä»–é…ç½®

#### 5.1. å…¨å±€è¿‡æ»¤å™¨

 Global Filters

å®šä¹‰è¿‡æ»¤å™¨

```java
@Bean
public GlobalFilter customFilter() {
    return new CustomGlobalFilter();
}

public class CustomGlobalFilter implements GlobalFilter, Ordered {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        log.info("custom global filter");
        return chain.filter(exchange);
    }

    @Override
    public int getOrder() {
        return -1;
    }
}


```





#### 5.2. Http timeouts configuration

Global  timeouts 

é…ç½®httpè¶…æ—¶

```yaml
spring:
  cloud:
    gateway:
      httpclient:
        connect-timeout: 1000
        response-timeout: 5s

```



#### 5.3. CORS Configuration

è·¨åŸŸé…ç½®

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: "https://docs.spring.io"
            allowedMethods:
            - GET
```



## åäºŒã€é¡¹ç›®æ•´åˆç½‘å…³

> 1. å®ç°ç»Ÿä¸€çš„ç”¨æˆ·é‰´æƒ ï¼Œç»Ÿä¸€çš„æ¥å£è°ƒç”¨æ¬¡æ•°ç»Ÿè®¡ï¼ˆæŠŠAPIç½‘å…³ç”¨åˆ°é¡¹ç›®ä¸­ï¼‰
> 2. å®Œå–„åŠŸèƒ½

**ä¼šç”¨åˆ°çš„ç‰¹æ€§**

1. è·¯ç”±ï¼ˆè½¬å‘è¯·æ±‚åˆ°æ¨¡æ‹Ÿæ¥å£é¡¹ç›®ï¼‰
2. ~~è´Ÿè½½å‡è¡¡ï¼ˆéœ€è¦ç”¨åˆ°æ³¨å†Œä¸­å¿ƒï¼‰~~
3. ç»Ÿä¸€é‰´æƒ(accessKeyï¼ŒsecretKey)
4. ç»Ÿä¸€å¤„ç†è·¨åŸŸ
5. ç»Ÿä¸€ä¸šåŠ¡å¤„ç†ï¼ˆæ¯æ¬¡è¯·æ±‚æ¥å£åï¼Œæ¥å£è°ƒç”¨æ¬¡æ•°+1ï¼‰
6. è®¿é—®æ§åˆ¶ï¼ˆé»‘ç™½åå•ï¼‰
7. ~~å‘å¸ƒæ§åˆ¶~~
8. æµé‡æŸ“è‰²(è®°å½•è¯·æ±‚æ˜¯å¦ä¸ºç½‘å…³æ¥çš„)
9. ~~ç»Ÿä¸€æ¥å£ä¿æŠ¤~~
   1. é™åˆ¶è¯·æ±‚
   2. ä¿¡æ¯è„±æ•
   3. é™çº§ï¼ˆç†”æ–­ï¼‰
   4. é™æµ å­¦ä¹ ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œå­¦ä¹ éœ²æ¡¶ç®—æ³•ï¼Œå­¦ä¹ ä¸€ä¸‹RedislimitHandler
   5. è¶…æ—¶æ—¶é—´
   6. é‡è¯•ï¼ˆä¸šåŠ¡ä¿æŠ¤ï¼‰
10. ç»Ÿä¸€æ—¥å¿—(è®°å½•æ¯æ¬¡çš„è¯·æ±‚å’Œå“åº”)
11. ~~ç»Ÿä¸€æ–‡æ¡£~~



**ä¸šåŠ¡é€»è¾‘**

1. ç”¨æˆ·å‘é€è¯·æ±‚åˆ°APIç½‘å…³
2. è¯·æ±‚æ—¥å¿—
3. é»‘ç™½åå•
4. ç”¨æˆ·é‰´æƒï¼ˆåˆ¤æ–­akï¼Œskæ˜¯å¦åˆæ³•ï¼‰
5. è¯·æ±‚çš„æ¨¡æ‹Ÿæ¥å£æ˜¯å¦å­˜åœ¨ï¼Ÿ
6. **è¯·æ±‚è½¬å‘ï¼Œè°ƒç”¨æ¨¡æ‹Ÿæ¥å£**
7. å“åº”æ—¥å¿—
8. è°ƒç”¨æˆåŠŸï¼Œæ¥å£è°ƒç”¨æ¬¡æ•°+1
9. è°ƒç”¨å¤±è´¥ï¼Œè¿”å›è§„èŒƒé”™è¯¯ç 



### 1ã€è¯·æ±‚è½¬å‘

ä½¿ç”¨PathåŒ¹é…æ–­è¨€Â 

æ‰€æœ‰å‰ç¼€ä¸ºï¼š/api/Â çš„è¯·æ±‚è¿›è¡Œè½¬å‘ï¼Œè½¬å‘åˆ°http://localhost:8123/api

æ¯”å¦‚è¯·æ±‚ç½‘å…³ï¼šhttp://localhost:8090/api/name/?name=archerè½¬å‘åˆ° http://localhost:8123/api/name/?name=archer

```yaml
server:  
  port: 8090  
  
spring:  
  cloud:  
    gateway:  
      routes:  
        - id: api_route  
          uri: http://localhost:8123  
          predicates:  
            - Path=/api/**
```

æµ‹è¯•æ²¡æœ‰é—®é¢˜

![image-20230201201022011](å¼€å‘æ–‡æ¡£.assets/image-20230201201022011.png)







### 2ã€Global Filter



ä½¿ç”¨äº†Global Filtersï¼Œå…¨å±€è¯·æ±‚æ‹¦æˆªå¤„ç†ï¼ˆç±»ä¼¼aopï¼‰

æŸ¥çœ‹[å®˜ç½‘](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#global-filters)ï¼Œä½¿ç”¨æ¨¡æ¿ä»£ç ä¸ºåŸºç¡€è¿›è¡Œç¼–å†™ç¨‹åº

```java
/**
 * å…¨å±€è¿‡æ»¤å™¨
 */
@Slf4j
@Component
public class CustomGlobalFilter implements GlobalFilter, Ordered {

	@Override
	public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
		log.info("custom global filter");
		return chain.filter(exchange);
	}

	@Override
	public int getOrder() {
		return -1;
	}

}

```





#### 2.1. è¯·æ±‚æ—¥å¿—

æˆ‘ä»¬å‚è€ƒä¹‹å‰çš„AOPçš„å†™æ³•ï¼Œä»exchangeè¿™ä¸ªè·¯ç”±äº¤æ¢æœºé‡Œé¢æ‹¿åˆ°æˆ‘ä»¬æ‰€æœ‰çš„è¯·æ±‚çš„ä¿¡æ¯Â 

```java
@Override
	public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
		// 1. è¯·æ±‚æ—¥å¿—
		ServerHttpRequest request = exchange.getRequest();
		log.info("è¯·æ±‚id: {}", request.getId());
		log.info("è¯·æ±‚è·¯å¾„: {}", request.getPath());
		log.info("è¯·æ±‚æ–¹æ³•: {}", request.getMethod());
		log.info("è¯·æ±‚å‚æ•°: {}", request.getQueryParams());
		log.info("è¯·æ±‚å¤´: {}", request.getHeaders());
		log.info("è¯·æ±‚åœ°å€: {}", request.getRemoteAddress());
		return chain.filter(exchange);
	}
```

![image-20230201204627949](å¼€å‘æ–‡æ¡£.assets/image-20230201204627949.png)



#### 2.2. æ·»åŠ é»‘ç™½åå•

å»ºè®®ç”¨ç™½åå•ï¼Œæ›´å®‰å…¨äº›

å¦‚æœè¿™ä¸ªæ¥æºåœ°å€ä¸æ˜¯ç™½åå•é‡Œé¢çš„ï¼Œæˆ‘ä»¬å°±ç›´æ¥è®¾ä¸ªçŠ¶æ€ç ï¼ˆè¿™é‡Œè®¾ç½®403ï¼‰ï¼Œç„¶åæ‹¦æˆªæ‰Â **response.setComplete()** å¯ä»¥ç†è§£ä¸ºè®¾ç½®å“åº”å®ŒæˆÂ 

```java
private static final List<String> IP_WHITE_LIST = Arrays.asList("127.0.0.1", "127.0.0.2");	

@Override
	public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
		// 1. è¯·æ±‚æ—¥å¿—
		ServerHttpRequest request = exchange.getRequest();
		String remoteAddress = request.getRemoteAddress().getHostString();
		log.info("è¯·æ±‚åœ°å€: {}", remoteAddress);
		// 2. è®¿é—®æ§åˆ¶ - é»‘ç™½åå•
		if (!IP_WHITE_LIST.contains(remoteAddress)){
			ServerHttpResponse response = exchange.getResponse();
			response.setStatusCode(HttpStatus.FORBIDDEN);
			return response.setComplete();
		}
		return chain.filter(exchange);
	}
```

å°†IP_WHITE_LISTè®¾ç½®ä¸ºé»‘åå• æµ‹è¯•è¢«æ‹’

![image-20230201205411510](å¼€å‘æ–‡æ¡£.assets/image-20230201205411510.png)



#### 2.3. ç”¨æˆ·é‰´æƒ

æ‰¾åˆ°ä¹‹å‰ç”¨æˆ·é‰´æƒçš„ä»£ç  å¤åˆ¶è¿‡æ¥Â ä¿®æ”¹ä¸€ä¸‹Â éœ€è¦å€’å…¥æˆ‘ä¹‹å‰åšçš„starter

```xml
<dependency>
    <groupId>com.xuan</groupId>
    <artifactId>xuanapi-client-sdk</artifactId>
    <version>0.0.1</version>
</dependency>
```



```java
	@Override
	public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
		// 1. è¯·æ±‚æ—¥å¿—
		ServerHttpRequest request = exchange.getRequest();
		log.info("è¯·æ±‚id: {}", request.getId());
		log.info("è¯·æ±‚è·¯å¾„: {}", request.getPath());
		log.info("è¯·æ±‚æ–¹æ³•: {}", request.getMethod());
		log.info("è¯·æ±‚å‚æ•°: {}", request.getQueryParams());
		log.info("è¯·æ±‚å¤´: {}", request.getHeaders());
		String remoteAddress = request.getRemoteAddress().getHostString();
		log.info("è¯·æ±‚åœ°å€: {}", remoteAddress);

		// 2. è®¿é—®æ§åˆ¶ - é»‘ç™½åå•
		if (!IP_WHITE_LIST.contains(remoteAddress)) {
			return handleNoAuth(exchange.getResponse());
		}

		// 3. ç”¨æˆ·é‰´æƒ
		HttpHeaders headers = request.getHeaders();
		String accessKey = headers.getFirst("accessKey");
		// é˜²æ­¢ä¸­æ–‡ä¹±ç 
		String body = null;
		try {
			body = URLDecoder.decode(headers.getFirst("body"), StandardCharsets.UTF_8.name());
		} catch (UnsupportedEncodingException e) {
			throw new RuntimeException(e);
		}
		String sign = headers.getFirst("sign");
		String nonce = headers.getFirst("nonce");
		String timestamp = headers.getFirst("timestamp");
		boolean hasBlank = StrUtil.hasBlank(accessKey, body, sign, nonce, timestamp);
		// åˆ¤æ–­æ˜¯å¦æœ‰ç©º
		if (hasBlank) {
			return handleInvokeError(exchange.getResponse());
		}
		// TODO ä½¿ç”¨accessKeyå»æ•°æ®åº“æŸ¥è¯¢secretKey
		// å‡è®¾æŸ¥åˆ°çš„secretæ˜¯abc è¿›è¡ŒåŠ å¯†å¾—åˆ°sign
		String secretKey = "abc";
		String sign1 = SignUtil.getSign(body, secretKey);
		if (!StrUtil.equals(sign, sign1)) {
			return handleInvokeError(exchange.getResponse());
		}
		// TODO åˆ¤æ–­éšæœºæ•°nonce
		// æ—¶é—´æˆ³æ˜¯å¦ä¸ºæ•°å­—
		if (!NumberUtil.isNumber(timestamp)) {
			return handleInvokeError(exchange.getResponse());
		}
		// äº”åˆ†é’Ÿå†…çš„è¯·æ±‚æœ‰æ•ˆ
		if (System.currentTimeMillis() - Long.parseLong(timestamp) > FIVE_MINUTES) {
			return handleInvokeError(exchange.getResponse());
		}
		// 4. è¯·æ±‚çš„æ¨¡æ‹Ÿæ¥å£æ˜¯å¦å­˜åœ¨ï¼Ÿ
		// 5. è¯·æ±‚è½¬å‘ï¼Œè°ƒç”¨æ¨¡æ‹Ÿæ¥å£
		// 6. å“åº”æ—¥å¿—
		// 7. è°ƒç”¨æˆåŠŸï¼Œæ¥å£è°ƒç”¨æ¬¡æ•°+1
		// 8. è°ƒç”¨å¤±è´¥ï¼Œè¿”å›è§„èŒƒé”™è¯¯ç 
		return chain.filter(exchange);
	}

	private Mono<Void> handleNoAuth(ServerHttpResponse response) {
		response.setStatusCode(HttpStatus.FORBIDDEN);
		return response.setComplete();
	}

	private Mono<Void> handleInvokeError(ServerHttpResponse response) {
		response.setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);
		return response.setComplete();
	}
```



#### 2.4. åˆ¤è¯»è¯·æ±‚çš„æ¥å£æ˜¯å¦å­˜åœ¨

æˆ‘ä»¬å¯ä»¥ä»**æ•°æ®åº“**ä¸­æŸ¥è¯¢æ¨¡æ‹Ÿæ¥å£æ˜¯å¦å­˜åœ¨ï¼Œä»¥åŠè¯·æ±‚æ–¹æ³•æ˜¯å¦åŒ¹é…ï¼ˆè¿˜å¯ä»¥æ ¡éªŒè¯·æ±‚å‚æ•°ï¼‰ å› ä¸ºç½‘å…³é¡¹ç›®æ²¡å¼•å…¥MyBatisç­‰æ“ä½œæ•°æ®åº“çš„ç±»åº“ï¼Œå¦‚æœè¯¥å­©æ“ä½œè¾ƒä¸ºå¤æ‚ï¼Œå¯ä»¥ç”±backendå¢åˆ æ”¹æŸ¥é¡¹ç›®æä¾›æ¥å£ï¼Œæˆ‘ä»¬ç›´æ¥è°ƒç”¨ï¼Œä¸ç”¨å†é‡å¤å†™é€»è¾‘äº†ã€‚

-   HTTPè¯·æ±‚ï¼ˆç”¨HTTPClientã€.ç”¨RestTemplateã€Feign)
-   RPC(Dubbo)



#### 2.5. è¯·æ±‚è½¬å‘ è°ƒç”¨æ¨¡æ‹Ÿæ¥å£

```java
		// 5. è¯·æ±‚è½¬å‘ï¼Œè°ƒç”¨æ¨¡æ‹Ÿæ¥å£
		Mono<Void> filter = chain.filter(exchange);
		// 6. å“åº”æ—¥å¿—
		log.info("å“åº”çŠ¶æ€ç ï¼š{}", response.getStatusCode());
		if (response.getStatusCode() == HttpStatus.OK) {
			// 7. è°ƒç”¨æˆåŠŸï¼Œæ¥å£è°ƒç”¨æ¬¡æ•°+1
		} else {
			// 8. è°ƒç”¨å¤±è´¥ï¼Œè¿”å›è§„èŒƒé”™è¯¯ç 
			return handleInvokeError(response);
		}
		return filter;
```

æ¥ä¸‹æ¥éœ€è¦ä¿®æ”¹å®¢æˆ·ç«¯çš„åœ°å€ï¼Œè®©å®ƒç»è¿‡ç½‘å…³

æ‰¾åˆ°SDKä¿®æ”¹åœ°å€

![image-20230202162858649](å¼€å‘æ–‡æ¡£.assets/image-20230202162858649.png)



#### 2.6. å¼‚æ­¥è¿”å›é—®é¢˜

åˆå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çš„æ¥å£è°ƒç”¨ï¼Œæ˜¯åœ¨è¿‡æ»¤å™¨å®Œæˆä¹‹åè¿›è¡Œçš„ï¼Œæ˜¯ä¸ª**å¼‚æ­¥æ“ä½œ**Â 

![image-20230202163045626](å¼€å‘æ–‡æ¡£.assets/image-20230202163045626.png)



é¢„æœŸæ˜¯ç­‰æ¨¡æ‹Ÿæ¥å£è°ƒç”¨å®Œæˆï¼Œæ‰è®°å½•å“åº”æ—¥å¿—ã€ç»Ÿè®¡è°ƒç”¨æ¬¡æ•°ã€‚
ä½†ç°å®æ˜¯ chain.fitter æ–¹æ³•ç«‹åˆ»è¿”å›äº†ï¼Œç›´åˆ° filter è¿‡æ»¤å™¨ return åæ‰è°ƒç”¨äº†æ¨¡æ‹Ÿæ¥å£ã€‚
åŸå› æ˜¯ï¼šchain.filter æ˜¯ä¸ªå¼‚æ­¥æ“ä½œï¼Œç†è§£ä¸ºå‰ç«¯çš„ promise

è§£æ±ºæ–¹æ¡ˆï¼šåˆ©ç”¨response è£…é¥°è€…ï¼Œå¢å¼ºåŸæœ‰ response çš„å¤„ç†èƒ½åŠ›
å‚è€ƒåšå®¢ï¼šhttps://blog.csdn.net/qq_19636353/article/details/126759522ï¼ˆä»¥è¿™ä¸ªä¸ºä¸»ï¼‰
å…¶ä»–å‚è€ƒï¼š
â€¢ https://blog.csdn.net/mo_67595943/article/details/124667975
â€¢ https://blog.csdn.net/weixin_43933728/article/details/121359727
â€¢ https://blog.csdn.net/zx156955/article/details/121670681
â€¢ https://blog.csdn.net/qq_39529562/article/details/108911983



è¿™äº›ä»£ç ä¸ç”¨è®°å¿† æœã€ŒSpring Cloud Gateway å“åº”æ—¥å¿—ã€å°±æœ‰äº†



å¤åˆ¶https://blog.csdn.net/qq_19636353/article/details/126759522  ä¸­çš„Response logä»£ç ã€‚å¹¶æ”¹å†™

```java
/**
	 * å¤„ç†å“åº”
	 *
	 * @param exchange
	 * @param chain
	 * @return
	 */
	private Mono<Void> handleResponse(ServerWebExchange exchange, GatewayFilterChain chain) {
		try {
			// ä»äº¤æ¢æœºæ‹¿åˆ°åŸå§‹response
			ServerHttpResponse originalResponse = exchange.getResponse();
			// ç¼“å†²åŒºå·¥å‚ æ‹¿åˆ°ç¼“å­˜æ•°æ®
			DataBufferFactory bufferFactory = originalResponse.bufferFactory();
			// æ‹¿åˆ°çŠ¶æ€ç 
			HttpStatus statusCode = originalResponse.getStatusCode();

			if (statusCode == HttpStatus.OK) {
				// è£…é¥°ï¼Œå¢å¼ºèƒ½åŠ›
				ServerHttpResponseDecorator decoratedResponse = new ServerHttpResponseDecorator(originalResponse) {
					// ç­‰è°ƒç”¨å®Œè½¬å‘çš„æ¥å£åæ‰ä¼šæ‰§è¡Œ
					@Override
					public Mono<Void> writeWith(Publisher<? extends DataBuffer> body) {
						log.info("body instanceof Flux: {}", (body instanceof Flux));
						// å¯¹è±¡æ˜¯å“åº”å¼çš„
						if (body instanceof Flux) {
							// æˆ‘ä»¬æ‹¿åˆ°çœŸæ­£çš„body
							Flux<? extends DataBuffer> fluxBody = Flux.from(body);
							// å¾€è¿”å›å€¼é‡Œé¢å†™æ•°æ®
							// æ‹¼æ¥å­—ç¬¦ä¸²
							return super.writeWith(fluxBody.map(dataBuffer -> {
								// TODO 7. è°ƒç”¨æˆåŠŸï¼Œæ¥å£è°ƒç”¨æ¬¡æ•°+1
								// dataä»è¿™ä¸ªcontentä¸­è¯»å–
								byte[] content = new byte[dataBuffer.readableByteCount()];
								dataBuffer.read(content);
								DataBufferUtils.release(dataBuffer);// é‡Šæ”¾æ‰å†…å­˜
								// 6.æ„å»ºæ—¥å¿—
								List<Object> rspArgs = new ArrayList<>();
								rspArgs.add(originalResponse.getStatusCode());
								String data = new String(content, StandardCharsets.UTF_8);// data
								rspArgs.add(data);
								log.info("<--- status:{} data:{}"// data
										, rspArgs.toArray());// log.info("<-- {} {}", originalResponse.getStatusCode(), data);
								return bufferFactory.wrap(content);
							}));
						} else {
							// 8.è°ƒç”¨å¤±è´¥è¿”å›é”™è¯¯çŠ¶æ€ç 
							log.error("<--- {} å“åº”codeå¼‚å¸¸", getStatusCode());
						}
						return super.writeWith(body);
					}
				};
				// è®¾ç½® response å¯¹è±¡ä¸ºè£…é¥°è¿‡çš„
				return chain.filter(exchange.mutate().response(decoratedResponse).build());
			}
			return chain.filter(exchange);// é™çº§å¤„ç†è¿”å›æ•°æ®
		} catch (Exception e) {
			log.error("gateway log exception.\n" + e);
			return chain.filter(exchange);
		}

	}
```

